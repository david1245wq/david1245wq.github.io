Chimera.Dashboard=new JS.Class(Chimera.Object,{block:null,currentRoute:null,currentParam:null,currentAction:"",widgets:[],initialize:function(attributes){this.callSuper(attributes);this.block=$(".dashboard-block");this.initNavigation();this.routing();$("body").on("load","img",function(){console.log("xxx");chimeraApplication.layoutManager.updateHeightGroups()})},initNavigation:function(){var self=this;setInterval(function(){self.routing()},100);if(!window.navInited){window.navInited=true;this.block.on("click",".navigation h2.h1",function(){var elem=$(this);var parent=elem.parent();var icon=elem.find(".icon");parent.toggleClass("closed");icon.toggleClass("dashboard-icon-nav-on");icon.toggleClass("dashboard-icon-nav-off")})}setTimeout(function(){self.block.find(".navigation").removeClass("animated fadeIn")},350)},routing:function(force){var route=window.location.href.split("#");route=route.length>1?route[1]:"home";route=route.split("?");var param=route.length>1?route[1]:"";route=route[0];if(this.currentRoute!=route||this.currentParam!=param||force){this.currentRoute=route;this.currentParam=param;this.block.find(".navigation a.active").removeClass("active");var menu=this.block.find('.navigation a.item[rel="'+route+'"]');if(menu.size())menu.addClass("active");var action=Chimera.String.camelize("action-"+route,"-");if(typeof this[action]=="function"){this.currentAction=Chimera.String.camelize(route,"-");this[action]()}else this.actionDefault()}},actionDefault:function(){var self=this;var content=$("#dashboardContent");var route=this.currentRoute;var param=this.currentParam;content.html('<div class="loader"></div>');$(window).scrollTo($(".dashboard-block"),{duration:250,axis:"y",offset:($(".header-block").height()+20)*-1});$.ajax({url:"/"+language+"/dashboard/"+route+(param?"?"+param:""),cache:false,async:true,complete:function(xhr){content.html(xhr.responseText).find(".widget").css("visibility","hidden");chimeraApplication.layoutManager.updateFixCols();chimeraApplication.layoutManager.updateHeightGroups();self.updateWidgets()},failed:function(xhr){}})},updateWidgets:function(){var self=this;this.widgets=[];$.each(this.block.find(".widget"),function(w,widget){var widgetElem=$(widget);var widgetName=widgetElem.data("widget");var widgetClass="Dashboard"+Chimera.String.ucFirst(widgetName);if(typeof Chimera[widgetClass]=="function")self.widgets[widgetName]=new Chimera[widgetClass]({app:self});widgetElem.find('input[type="email"]').emailautocomplete({domains:EMAIL_DOMAINS});setTimeout(function(){widgetElem.css("visibility","visible").addClass("animated fadeIn")},w*50)});chimeraApplication.layoutManager.updateHeightGroups()},actionLogout:function(){window.location.href="/users/logout"},post:function(url,data,callback){data[csrfParam]=csrfToken;$.ajax({url:url,async:true,cache:false,data:data,method:"POST",complete:function(xhr){var response=$.parseJSON(xhr.responseText);csrfToken=response[csrfParam];if(callback)callback(response.data)}})}});Chimera.DashboardWidget=new JS.Class(Chimera.Object,{app:null,luhnCalculate:function(originalStr){var i,sum=0,delta=[0,1,2,3,4,-4,-3,-2,-1,0];for(i=0;i<originalStr.length;i++)sum+=parseInt(originalStr.substring(i,i+1));for(i=originalStr.length-1;i>=0;i-=2)sum+=delta[parseInt(originalStr.substring(i,i+1))];if(10-sum%10===10)return 0;return 10-sum%10},luhnValidate:function(luhnStr){var luhnStrDigit,luhnStrLess;luhnStrDigit=parseInt(luhnStr.substring(luhnStr.length-1,luhnStr.length));luhnStrLess=luhnStr.substring(0,luhnStr.length-1);return this.luhnCalculate(luhnStrLess)===parseInt(luhnStrDigit)}});Chimera.DashboardBuyCredits=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes);chimeraApplication.shopManager.initBuyButtons();var button=$('.widget[data-widget="buyCredits"] a.button');$("#creditQuantity").change(function(){var input=$(this);var value=input.val().replace(/[^0-9]/gi,"")*1;value=Math.round(value/10)*10;value=Math.max(minCredits,value);value=Math.min(maxCredits,value);input.val(value);$("#creditPrice").val(Math.round(value*creditPrice*100)/100);button.attr("data-cart","Credit:"+value)});button.click(function(){if(!$(this).hasClass("disabled")){$(this).addClass("disabled").prop("disabled");setTimeout(function(){window.location.href="/"+language+"/cart"},1E3)}})}});Chimera.DashboardBuyHardware=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes);var self=this;$("#hardwareId").change(function(){var select=$(this);var value=select.val();var option=select.find('option[value="'+value+'"]');var need=option.data("need")*1==1;$(".buy-hardware .data-price").html(option.data("price"));$(".buy-hardware .data-url").attr("href",option.data("url"));$(".buy-hardware img").attr("src",option.data("img"));if(need)$(".licence-row").removeClass("hidden");else $(".licence-row").addClass("hidden").find("select").val(0);self.updateButton();chimeraApplication.layoutManager.updateAll()}).trigger("change");$("#licenceId").change(function(){self.updateButton()}).trigger("change");$(".buy-hardware a.button").click(function(){var button=$(this);var licence=$("#licenceId").val()*1;var hardware=$("#hardwareId").val()*1;if(!button.prop("disabled")&&!button.attr("href")){button.prop("disabled",true);var fly=chimeraApplication.shopManager.createFly(button);setTimeout(function(){if(!hardware&&licence&&licence==premiumLicenceId)$.ajax({url:addToCartUrl+"?add=Licence:"+licence,cache:false,async:true,dataType:"JSON",complete:function(response){chimeraApplication.shopManager.moveFly(fly);var cart=response.responseJSON;if(cart.success)chimeraApplication.shopManager.setCartInfo(cart);window.location.href="/"+language+"/cart"}});else $.ajax({url:addToCartUrl+"?add=Hardware:"+hardware,cache:false,async:true,dataType:"JSON",complete:function(response){if(licence)$.ajax({url:addToCartUrl+"?add=Licence:"+
licence,cache:false,async:true,dataType:"JSON",complete:function(response){chimeraApplication.shopManager.moveFly(fly);var cart=response.responseJSON;if(cart.success)chimeraApplication.shopManager.setCartInfo(cart);window.location.href="/"+language+"/cart"}});else{chimeraApplication.shopManager.moveFly(fly);var cart=response.responseJSON;if(cart.success)chimeraApplication.shopManager.setCartInfo(cart);window.location.href="/"+language+"/cart"}}})},1500)}})},updateButton:function(){var select=$("#hardwareId");var value=select.val();var option=select.find('option[value="'+value+'"]');var need=option.data("need")*1==1;var stock=option.data("stock")*1;if(!stock){$("#outOfStock").show();$(".buy-hardware a.button").hide()}else{$("#outOfStock").hide();$(".buy-hardware a.button").show()}if(stock&&value&&!need||need&&$("#licenceId").val()*1>0)$(".buy-hardware a.button").removeClass("disabled").prop("disabled",false);else $(".buy-hardware a.button").addClass("disabled").prop("disabled",true)}});Chimera.DashboardBuyBundle=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes);var self=this;$("#bundleId").change(function(){var select=$(this);var value=select.val();var option=select.find('option[value="'+value+'"]');$(".buy-bundle .data-price").html(option.data("price"));$(".buy-bundle .data-url").attr("href",option.data("url"));$(".buy-bundle img").attr("src",option.data("img"));self.updateButton();chimeraApplication.layoutManager.updateAll()}).trigger("change");$(".buy-bundle a.button").click(function(){var button=$(this);var bundle=$("#bundleId").val()*1;if(!button.prop("disabled")&&!button.attr("href")){button.prop("disabled",true);var fly=chimeraApplication.shopManager.createFly(button);setTimeout(function(){$.ajax({url:addToCartUrl+"?add=Bundle:"+bundle,cache:false,async:true,dataType:"JSON",complete:function(response){chimeraApplication.shopManager.moveFly(fly);var cart=response.responseJSON;if(cart.success)chimeraApplication.shopManager.setCartInfo(cart);window.location.href="/"+language+"/cart"}})},1500)}})},updateButton:function(){var select=$("#bundleId");var value=select.val();var option=select.find('option[value="'+value+'"]');$(".buy-bundle a.button").show().removeClass("disabled").prop("disabled",false)}});Chimera.DashboardNotifications=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes);var self=this;$(document).on("click",".notification .mark-as-readed",function(){var link=$(this);link.hide();link.parent().find(".new, .important").hide();link.parent().parent().find(".new, .important").hide();link.parent().parent().find("div").css("font-weight","normal");$.ajax({url:"/"+language+"/dashboard/mark-notification/"+link.data("id"),cache:false,async:true})});$(document).on("click",".notification .show-details",function(){var link=$(this);link.hide();link.parent().find(".short").hide();link.parent().find(".detailed").removeClass("hidden");chimeraApplication.layoutManager.updateAll()});$(document).on("click",".notification-actions .button",function(){var button=$(this);if(!button.hasClass("disabled")){$(".notification-actions .button").addClass("disabled");var id=button.data("id");var action=button.data("action");$.ajax({url:"/"+language+"/dashboard/mark-notification/"+
id+"?action="+action,cache:false,async:true,complete:function(){self.reloadWidget()}})}})},reloadWidget:function(){var widget=$(".widget-notifications");var page=widget.find(".pager a.active").data("page")*1;page=page?page:1;widget.html('<div class="loader"></div>');$.ajax({url:"/"+language+"/dashboard/notifications?page="+page,async:true,cache:false,complete:function(xhr){widget.parent().parent().replaceWith(xhr.responseText);chimeraApplication.layoutManager.updateAll()}})}});Chimera.DashboardLicences=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes)},licenceBuy:function(userLicenceId,licenceId,button){var fly=chimeraApplication.shopManager.createFly($(button));setTimeout(function(){$.ajax({url:addToCartUrl+"?add=Licence:"+licenceId,cache:false,async:true,dataType:"JSON",complete:function(response){chimeraApplication.shopManager.moveFly(fly);var cart=response.responseJSON;if(cart.success)chimeraApplication.shopManager.setCartInfo(cart);window.location.href="/"+language+"/cart"}})},1E3)},licenceExtend:function(userLicenceId,licenceId,button){button.addClass("disabled").prop("disabled",true);window.location.href="#licence-details?extend=1&id="+userLicenceId},licenceUpgrade:function(userLicenceId,licenceId,button){button.addClass("disabled").prop("disabled",true);window.location.href="#licence-details?upgrade=1&id="+userLicenceId},licenceDetails:function(userLicenceId,licenceId,button){button.addClass("disabled").prop("disabled",true);window.location.href="#licence-details?id="+userLicenceId}});Chimera.DashboardCoupons=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes);var self=this;$(document.body).on("change",".widget-coupons #coupon",function(e){var select=$(this);var wrapper=select.parent();var id="coupon-"+select.val();wrapper.find(".coupon").addClass("hidden");wrapper.find("#"+id).removeClass("hidden")});$(document.body).on("change",".widget-coupons .inner select",function(e){var select=$(this);var value=select.val()*1;var button=select.parent().find(".button");if(value)button.removeClass("disabled").removeAttr("disabled").prop("disabled",false);else button.addClass("disabled").attr("disabled","disabled").prop("disabled",true)});$(document.body).on("click",".widget-coupons .button",function(e){var button=$(this);if(button.hasClass("disabled")){e.stopPropagation();return false}else button.addClass("disabled").attr("disabled","disabled").prop("disabled",true).html('<i class="fa fa-fw fa-cog fa-spin"></i>');var code=button.data("code");var select=button.parent().find("select");if(select.size()){select.addClass("disabled").attr("disabled","disabled").prop("disabled",true);var userLicenceId=select.val()*1;if(userLicenceId){var option=select.find('option[value="'+userLicenceId+'"]');var licenceId=option.data("licence-id")*1;$.ajax({url:addToCartUrl+"?add=Extend:"+userLicenceId+":"+licenceId+":0",cache:false,async:true,dataType:"JSON",complete:function(response){self.handleAjax(code,button)}})}}else self.handleAjax(code,button);e.stopPropagation();return false})},handleAjax:function(code,button){$.ajax({url:"/"+language+"/shop/setCartProperty?property=selectedCoupon&value="+code,method:"GET",cache:false,complete:function(response){$.ajax({url:"/"+language+"/shop/setCartProperty?property=couponCode&value="+code,method:"GET",cache:false,complete:function(response){var licence=parseInt(button.data("licence"));licence=isNaN(licence)?0:licence;if(licence)$.ajax({url:addToCartUrl+"?add=Licence:"+licence,method:"GET",cache:false,complete:function(response){window.location.href="/"+language+
"/shop/cart"}});else window.location.href="/"+language+"/shop/cart"}})}})}});Chimera.DashboardActiveLicences=new JS.Class(Chimera.DashboardWidget,{type:"active",initialize:function(attributes){this.callSuper(attributes);var self=this;var widget=$(".widget-"+this.type+"Licences");$(document.body).on("click",".button.disabled",function(e){e.stopPropagation();return false});widget.find("select").change(function(){var select=$(this);var value=select.val()*1;var attach=select.parent().parent().find(".attach-button");if(value)attach.removeClass("disabled").prop("disabled",false);else attach.addClass("disabled").prop("disabled",true)});widget.find(".attach-button").click(function(){var button=$(this);var select=button.parent().parent().find("select");if(!button.hasClass("disabled")){var userLicenceId=button.data("id")*1;var connectableId=select.val()*1;if(userLicenceId>0&&connectableId>0){select.prop("disabled",true).addClass("disabled");button.prop("disabled",true).addClass("disabled");$.ajax({url:"/"+language+"/dashboard/attach?u="+userLicenceId+"&c="+connectableId,cache:false,async:true,complete:function(xhr){var response=$.parseJSON(xhr.responseText);if(response&&response.message)alert(response.message);window.location.reload(true)}})}}});widget.find(".detach-button").click(function(){var button=$(this);var select=button.parent().parent().find("select");if(!button.hasClass("disabled")){var userLicenceId=button.data("id")*1;if(userLicenceId>0){select.prop("disabled",false).removeClass("disabled");button.prop("disabled",true).addClass("disabled");$.ajax({url:"/"+language+
"/dashboard/detach?u="+userLicenceId,cache:false,async:true,complete:function(xhr){var response=$.parseJSON(xhr.responseText);if(response&&response.message)alert(response.message);window.location.reload(true)}})}}})}});Chimera.DashboardExpiredLicences=new JS.Class(Chimera.DashboardActiveLicences,{type:"expired",initialize:function(attributes){this.callSuper(attributes)}});Chimera.DashboardLicenceDetails=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes);$(".widget-licenceDetails .action-button").click(function(){var button=$(this).addClass("disabled").prop("disabled",true);var data=button.data("params");$.ajax({url:addToCartUrl+"?add="+data,cache:false,async:true,dataType:"JSON",complete:function(response){var cart=response.responseJSON;if(cart.success)chimeraApplication.shopManager.setCartInfo(cart);window.location.href="/"+language+"/cart"}})})}});Chimera.DashboardResellerSettings=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes);var self=this;$(".widget-resellerSettings select").selectize({});$(".widget-resellerSettings #warningCreditLevel").change(function(){var inp=$(this);var val=inp.val()*1;val=isNaN(val)?100:val;val=val<100?100:val;inp.val(val)});var addMore=$(".add-more-contacts");addMore.find("a").click(function(){var a=$(this);var id=a.attr("id");var row=$("#"+id.replace("Add","Row"));row.removeClass("hidden");a.addClass("hidden");if(addMore.find("a:not(.hidden)").size())addMore.show();else addMore.hide();row.find("input").focus();chimeraApplication.layoutManager.updateAll()});$(".contacts-section .remove").click(function(){$(this).parent().parent().find("input").val("").trigger("change")});$(".contacts-section input").on("change blur",function(){var input=$(this);var value=$.trim(input.val())+"";if(!value.length){input.val("");var id=input.attr("id");$("#"+id+"Row").addClass("hidden");$("#"+id+"Add").removeClass("hidden");if(addMore.find("a:not(.hidden)").size())addMore.show();else addMore.hide()}chimeraApplication.layoutManager.updateAll()});$(".widget-resellerSettings .button.submit").click(function(){$(".widget-resellerSettings .success-box, .widget-resellerSettings .error-box").removeClass("animated fadeIn").hide();var data=$("#resellerSettingsForm").serializeObject();console.dir(data);self.app.post("/"+language+"/dashboard/save-reseller",data,function(response){$("#resellerSettingsForm").find("span.error").replaceWith("");if(response.error){var hasDetail=false;if(response.errorDetails)$.each(response.errorDetails,function(field,error){$("#resellerSettingsForm #"+field).closest(".form-row").find("label").after('<span class="db error animated fadeIn" style="font-size: 11px; font-weight: bold; color: #C04343; padding-bottom: 5px; margin-top: -5px;">'+error+"</span>");hasDetail=true});if(!hasDetail)$(".widget-resellerSettings .error-box").show().addClass("animated fadeIn")}else{$(".widget-resellerSettings .success-box").show().addClass("animated fadeIn");if(typeof response.emptyResellerData!=="undefined"&&response.emptyResellerData===false){$(".widget-resellerFeedback .box.instructions div.il-t:nth-child(2)").removeClass("next").addClass("check");$(".widget-resellerFeedback .box.instructions div.il-t:nth-child(3)").addClass("next")}if(response.apiKey){$("#apiKeyRow").show().find("input").val(response.apiKey);$("#apiDocRow").show();$("#resellerSettingsNeeded").hide()}if(response.emailChanged)$("#emailChangedRow").show().addClass("animated fadeIn");window.scrollTo(0,0)}})});$(".widget-resellerSettings .api-btn").click(function(){$(".widget-resellerSettings .success-box, .widget-resellerSettings .error-box").removeClass("animated fadeIn").hide();$.ajax({url:"/"+language+"/dashboard/regenerate-api-key",cache:false,async:true,complete:function(xhr){var response=$.parseJSON(xhr.responseText);if(response.error)$(".widget-resellerSettings .error-box").show().addClass("animated fadeIn");else if(response.apiKey)$("#apiKeyRow").show().find("input").val(response.apiKey)}})});$(".widget-resellerSettings .reseller-web-pages").on("click",".button",function(e){var button=$(this);if(button.find("i").hasClass("fa-times"))button.parent().replaceWith("");else{button.parent().parent().append('<span class="db field"><input type="text" required name="webPages[]" id="webPages_x" value=""><a class="il-m button"><span class="icon"><i class="fa fa-fw fa-plus"></i></span></a></span>');var fields=$(".widget-resellerSettings .reseller-web-pages .field");$.each(fields,function(f,field){field=$(field);field.find("input").attr("id","webPages_"+f);if(f<fields.length-1)field.find(".button").addClass("gray").find("i").removeClass("fa-plus").addClass("fa-times")})}e.stopPropagation();return false})}});Chimera.DashboardUserSettings=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes);var self=this;var submit=$(".widget-userSettings .button.submit");$(".widget-userSettings #timezone").selectize({});var unsubscribe=this.app.currentParam==="unsubscribe=1";submit.click(function(){$(".widget-userSettings .success-box, .widget-userSettings .error-box").removeClass("animated fadeIn").hide();var data=$("#userSettingsForm").serializeObject();self.app.post("/"+
language+"/dashboard/save-user?unsubscribe="+(unsubscribe?"1":"0"),data,function(response){$("#userSettingsForm").find("span.error").replaceWith("");if(response.error){var hasDetail=false;if(response.errorDetails)$.each(response.errorDetails,function(field,error){$("#userSettingsForm #"+field).closest(".form-row").find("label").after('<span class="db error animated fadeIn" style="font-size: 11px; font-weight: bold; color: #C04343; padding-bottom: 5px; margin-top: -5px;">'+error+"</span>");hasDetail=true});if(!hasDetail)$(".widget-userSettings .error-box").show().html(response.message).addClass("animated fadeIn")}else{unsubscribe=false;$(".widget-userSettings .success-box").show().html(response.message).addClass("animated fadeIn");if(response.emailChanged)$(".widget-userSettings .changed-box").show().addClass("animated fadeIn");window.scrollTo(0,0)}if(response.captcha){$("#captcha").val("");$("#captchaRow span.field").html(response.captcha)}if(response.needReload)window.location.reload(true)})});if(unsubscribe){$("#sendNewsletter").attr("checked",false).prop("checked",false);submit.trigger("click")}var tChannelLink=$(".telegram-channel a.on-off");var tChannelPanel=$(".telegram-panel");var tUsernameInput=$(".telegram-panel input");var tCloseButton=$(".telegram-panel a.close");var tJoinButton=$(".telegram-panel .telegram-username .button");var tLinkHref=tChannelLink.data("href");var tSubscribed=tChannelLink.data("subscribed");var tSubscribeInput=$("#telegramSubscribe");tChannelLink.click(function(e){var em=tChannelLink.find("em");if(tChannelLink.hasClass("on")){em.html(tChannelLink.data("off"));tSubscribeInput.val("0");$.getJSON("/"+language+"/dashboard/save-telegram",function(response){})}else{em.html(tChannelLink.data("on"));tChannelPanel.removeClass("hidden");$(document.body).scrollTo($(".widget-userSettings"),500,{axis:"y",offset:-105});tUsernameInput.focus();tSubscribeInput.val("1")}tChannelLink.toggleClass("on off");e.stopPropagation();return false});var tChangeUsername=function(){var value=tUsernameInput.val();var valid=value.indexOf("@")===-1&&value.length;if(valid)tJoinButton.removeClass("disabled").removeAttr("disabled").prop("disabled",false);else tJoinButton.addClass("disabled").attr("disabled","disabled").prop("disabled",true);return true};tUsernameInput.focus(function(){tUsernameInput.parent().addClass("focus");return true}).blur(function(){tUsernameInput.parent().removeClass("focus");return true}).change(tChangeUsername).keyup(tChangeUsername);tCloseButton.click(function(e){if(!tSubscribed&&tChannelLink.hasClass("on")){tChannelLink.toggleClass("on off");tChannelLink.find("em").html(tChannelLink.data("off"));tSubscribeInput.val("0")}tChannelPanel.addClass("hidden");e.stopPropagation();return false});tJoinButton.click(function(e){if(!tJoinButton.hasClass("disabled"))$.getJSON("/"+language+"/dashboard/save-telegram/?username="+encodeURIComponent(tUsernameInput.val()),function(response){console.dir(response);if(response.success){window.location.href=tLinkHref;if(!tSubscribed)window.location.reload();tChannelPanel.addClass("hidden");e.stopPropagation()}else alert(response.error)});e.stopPropagation();return false})}});Chimera.DashboardAddressForm=new JS.Class(Chimera.DashboardWidget,{checkAddressTimeout:null,checkAddressXhr:null,checkAddressResults:[],lastCheckedAddress:"",checkAddressExistingTimeout:null,addressExists:false,addressAccept:false,phoneNumberValid:false,validatePhoneNumber:function(){this.phoneNumberValid=null;var input=$("#phone");var value=input.val()+"";value=value.replace(/[^0-9]/gi,"");if(value.length){value="+"+value;var parsedPhoneNumber=libphonenumber.parsePhoneNumberFromString(value);this.phoneNumberValid=!!(parsedPhoneNumber&&parsedPhoneNumber.isValid());if(this.phoneNumberValid&&parsedPhoneNumber.number)input.val(parsedPhoneNumber.format("INTERNATIONAL"))}this.updateButtonAndMessages()},initialize:function(attributes){this.callSuper(attributes);var self=this;this.validatePhoneNumber();$("#phone").change(function(){self.validatePhoneNumber()}).keyup(function(){self.validatePhoneNumber()});$(".widget-addressForm #countryId").selectize({});$(".address-fields").removeClass("hidden");$("#street, #houseNumber, #countryId").change(function(){self.streetOrHouseNumberChanged()});self.streetOrHouseNumberChanged();$(".widget-addressForm .submit").click(function(){var button=$(this);if(button.hasClass("disabled")){var acceptRow=$("#addressRowAccept");if(!self.addressAccept&&!acceptRow.hasClass("hidden")){acceptRow.addClass("animated pulse");setTimeout(function(){acceptRow.removeClass("animated pulse")},500)}return}button.addClass("disabled");var data=$("#addressForm").serializeObject();if(window.location.href.indexOf("billing=1")!==-1)data.accept=1;$(".widget-addressForm input, .widget-addressForm select").removeClass("error");$(".widget-addressForm .error-box.top").hide();$(".widget-addressForm .success-box.sb").hide();self.app.post("/"+language+"/dashboard/save-address",data,function(response){button.removeClass("disabled");if(response.error){$(".widget-addressForm .address-suggestions").hide();$(".widget-addressForm .success-box.sb").hide();$(".widget-addressForm .error-box.top").show().html(response.message).addClass("animated fadeIn");if(response.errorFields)$.each(response.errorFields,function(f,field){$("#"+field).addClass("error")});self.showSuggestions();if(!self.addressAccept)$("#addressRowAccept").removeClass("hidden")}else{$(".widget-addressForm .address-suggestions").replaceWith('<div class="box address-suggestions"></div>');$(".widget-addressForm .error-box.top").hide();$(".widget-addressForm .success-box.sb").show().html(response.message).addClass("animated fadeIn");if(response.id)$(".widget-addressForm #id").val(response.id);if(window.location.href.indexOf("cart=1")!==-1){var url=cartUrl;if(window.location.href.indexOf("billing=1")!==-1)url+="?billingAddressId="+response.id;window.location.href=url}$("#addressRowAccept").addClass("hidden")}})});$(".widget-addressForm #find").keyup(function(){if($(this).val().length){if(self.checkAddressTimeout){clearTimeout(self.checkAddressTimeout);self.loader(false)}self.loader(true);self.checkAddressTimeout=setTimeout(function(){self.checkAddress();clearTimeout(self.checkAddressTimeout)},1500)}else{if(self.checkAddressTimeout)clearTimeout(self.checkAddressTimeout);self.loader(false)}});$(".widget-addressForm #accept").change(function(){self.addressAccept=$(this).prop("checked");self.updateButtonAndMessages()});if(window.location.href.indexOf("create-address")>-1&&chimeraApplication){$(".widget-addressForm .fc12").find("input, select").change(function(){if(self.checkAddressExistingTimeout)clearTimeout(self.checkAddressExistingTimeout);self.checkAddressExistingTimeout=setTimeout(function(){self.checkAddressExisting();clearTimeout(self.checkAddressExistingTimeout)},250)}).blur(function(){if(self.checkAddressExistingTimeout)clearTimeout(self.checkAddressExistingTimeout);self.checkAddressExistingTimeout=setTimeout(function(){self.checkAddressExisting();clearTimeout(self.checkAddressExistingTimeout)},250)});self.loader(true);var addressCallback=function(address){self.loader(false);if(address.formatted&&chimeraApplication.positionAccuracy>0&&chimeraApplication.positionAccuracy<100)$("#find").val(address.formatted).trigger("keyup")};if(FRAUD_CHECK_REQUIRED){$(".widget-addressForm").find("input, select").attr("readonly","readonly").attr("disabled","disabled").addClass("disabled");chimeraApplication.getPosition(function(lat,lng,acc,src){$.ajax({url:"/"+language+"/shop/save-geo?lat="+encodeURIComponent(lat)+"&lng="+encodeURIComponent(lng)+"&acc="+encodeURIComponent(acc)+"&src="+encodeURIComponent(src),cache:false,async:true,method:"get",success:function(response){if(response&&response.results&&response.results[0]&&response.results[0].formatted_address){$(".widget-addressForm").find("input, select").removeAttr("readonly").removeAttr("disabled").removeClass("disabled");addressCallback({formatted:response.results[0].formatted_address})}else{alert("An error occurred, please try again!");window.location.reload()}}})})}else chimeraApplication.getAddress(addressCallback)}},streetOrHouseNumberChanged:function(){var street=$("#street").val();var countryId=$("#countryId").val()*1;var houseNumber=$("#houseNumber").val();var address1=(street?street+" ":"")+houseNumber;var self=this;$("#address1").val(address1);if(street&&houseNumber)self.getHouseNumberByCountryId(countryId,houseNumber,street)},getHouseNumberByCountryId:function(countryId,houseNumber,street){$.getJSON("/"+language+"/dashboard/get-house-number-position-by-country?countryId="+
countryId,function(response){if(typeof response!=="undefined"&&typeof response.position!=="undefined"){$("#addressRowAddress1").removeClass("left, right").addClass(response.position);if(response.position==="right")$("#address1").val((street+" "+houseNumber).trim());else $("#address1").val((houseNumber+" "+street).trim())}})},getSuggestions:function(callback){var selectedCountry="US";var zipCode=$("#zipcode").val();var city=$("#city").val();var address=$("#address1").val();var searchValue=encodeURIComponent((zipCode?zipCode+" ":"")+(city?city+" ":"")+(address?address+" ":""));var bingCulture=language;var url="/"+language+"/dashboard/address-suggestions?searchValue="+searchValue+"&selectedCountry="+selectedCountry+"&bingCulture="+bingCulture;$(document.body).css("cursor","progress");$.getJSON(url,null,callback)},showSuggestions:function(){this.getSuggestions(function(response){if(response&&response.length){var html='<div class="box address-suggestions animated fadeIn"><strong class="db">Did you mean?</strong>';$.each(response,function(s,suggestion){if(typeof google!="undefined"&&typeof google.maps!="undefined"&&typeof google.maps.places!="undefined"&&suggestion.googlePlaceId)html+='<a class="db main" href="#" onclick="return dashboardApplication.widgets.addressForm.selectSuggestion(\''+suggestion.googlePlaceId+"')\">"+suggestion.label+"</a>";else html+='<span class="db">'+suggestion.label+"</span>"});html+="</div>";$(".widget-addressForm .address-suggestions").replaceWith(html);$(document.body).css("cursor","auto")}})},suggestionMap:null,suggestionService:null,selectSuggestion:function(googlePlaceId){var self=this;$(document.body).css("cursor","progress");if(!this.suggestionMap){this.suggestionMap=new google.maps.Map(document.getElementById("hiddenMap"),{zoom:15});this.suggestionService=new google.maps.places.PlacesService(this.suggestionMap)}this.suggestionService.getDetails({placeId:googlePlaceId,fields:["formatted_address","address_components"]},function(place,status){if(status==="OK"&&place.formatted_address)$("#find").val(place.formatted_address).trigger("keyup");$(document.body).css("cursor","auto")});$(".widget-addressForm .address-suggestions").replaceWith('<div class="box address-suggestions"></div>');return false},checkAddressExisting:function(){var self=this;var address={"countryId":$(".widget-addressForm #countryId").val(),"state":$(".widget-addressForm #state").val(),"zipcode":$(".widget-addressForm #zipcode").val(),"city":$(".widget-addressForm #city").val(),"address1":$(".widget-addressForm #address1").val(),"address2":$(".widget-addressForm #address2").val()};var lastCheckedAddress=""+address.countryId+address.state+address.zipcode+address.city+address.address1+address.address2;if(lastCheckedAddress.length&&lastCheckedAddress!==this.lastCheckedAddress){this.lastCheckedAddress=lastCheckedAddress;$.ajax({url:"/"+language+"/dashboard/check-address-existing",method:"GET",async:true,cache:false,data:address,success:function(response){response=$.parseJSON(response);if(window.location.href.indexOf("billing=1")!==-1)self.addressExists=false;else self.addressExists=response&&response.exists;self.updateButtonAndMessages()}})}},updateButtonAndMessages:function(){var button=$(".widget-addressForm .button.submit");var message=$(".widget-addressForm .exists-message");var phoneMessage=$(".widget-addressForm .phone-message");var acceptRow=$("#addressRowAccept");button.addClass("disabled");message.addClass("hidden");phoneMessage.addClass("hidden");if((this.addressAccept||acceptRow.hasClass("hidden"))&&!this.addressExists&&this.phoneNumberValid!==false)button.removeClass("disabled");if(this.addressExists)message.removeClass("hidden");if(this.phoneNumberValid===false)phoneMessage.removeClass("hidden")},checkAddress:function(){var self=this;$(".widget-addressForm #addressRowFind .box").addClass("hidden");$(".widget-addressForm #addressRowFind .pick-address").addClass("hidden").find("div").html("");var address=$(".widget-addressForm #find").val();if(address){if(this.checkAddressXhr)this.checkAddressXhr.abort();this.checkAddressXhr=$.ajax({url:"/users/check-address?address="+window.encodeURIComponent(address),cache:false,async:true,success:function(responseText){var response=$.parseJSON(responseText);self.checkAddressResults=response.results;self.updateAddressResults();self.checkAddressXhr=null}})}else this.clearAddress()},updateAddressResults:function(){var self=this;if(this.checkAddressResults.length>0){var html="";$.each(this.checkAddressResults,function(a,address){var zip=[];if(address.countryCode)zip.push(address.countryCode);if(address.zipcode)zip.push(address.zipcode);zip=zip.join("-");var line2=[];if(zip)line2.push(zip);if(address.city)line2.push(address.city);line2=line2.join(" ");html+=address.address1||address.address2||line2?""+'<a class="db">'+(address.address1?'<strong class="db">'+address.address1+"</strong>":"")+(line2?'<span class="db">'+line2+"</span>":"")+(address.address2?'<em class="db">'+address.address2+"</em>":"")+"</a>":""});$(".widget-addressForm #addressRowFind .pick-address div").html(html);$(".widget-addressForm #addressRowFind .pick-address").removeClass("hidden");$.each($(".widget-addressForm #addressRowFind .pick-address div a"),function(ix,a){$(a).click(function(){self.pickAddress(ix)})});if(this.checkAddressResults.length===1)this.pickAddress(0)}else{$(".widget-addressForm #addressRowFind .box.info-box").removeClass("hidden");this.clearAddress()}this.loader(false)},pickAddress:function(ix){if(this.checkAddressTimeout)clearTimeout(this.checkAddressTimeout);if(this.checkAddressResults[ix]){var result=this.checkAddressResults[ix];$.each(result,function(name,value){if(name==="countryId")$(".widget-addressForm #countryId")[0].selectize.setValue(value,false);else $("#"+name).val(value).trigger("change")});$(".address-fields").removeClass("hidden");$(".address-fields .form-row").addClass("animated fadeIn");setTimeout(function(){$(".address-fields .form-row").removeClass("animated fadeIn")},1E3)}$(".widget-addressForm #addressRowFind .pick-address div").html("");$(".widget-addressForm #addressRowFind .pick-address").addClass("hidden");$(".widget-addressForm #addressRowFind .box.success-box").removeClass("hidden");$(".widget-addressForm .button.submit").addClass("disabled");$(".widget-addressForm #accept").prop("checked",false);this.addressExists=false;this.addressAccept=window.location.href.indexOf("billing")>-1;this.updateButtonAndMessages();this.streetOrHouseNumberChanged()},clearAddress:function(){$(".address-fields").removeClass("hidden");$(".address-fields input").val("").trigger("change");$(".address-fields #countryId")[0].selectize.setValue(0,false);$(".widget-addressForm #accept").prop("checked",false);$(".widget-addressForm .button.submit").addClass("hidden");this.addressExists=false;this.addressAccept=window.location.href.indexOf("billing")>-1;this.updateButtonAndMessages();this.loader(false)},loader:function(show){var loader=$(".widget-addressForm .search-loader");if(show)loader.addClass("visible");else loader.removeClass("visible")}});Chimera.DashboardOnlineServices=new JS.Class(Chimera.DashboardWidget,{widget:null,initialize:function(attributes){this.callSuper(attributes);this.widget=$(".widget-onlineServices");var emptyOption='<option value="0">&mdash;</option>';var needModel=false;var self=this;var isAndroid=/(android)/i.test(navigator.userAgent);this.widget.find("#imei").on("keydown keyup change blur",function(e){if(e.keyCode!=8){var value=$(this).val().split("-");var num=(value[0]+value[1]+value[2]).replace(/[^0-9]/gi,"");if(true)$(this).inputmask("999999-99-999999-"+self.luhnCalculate(num),{disablePredictiveText:true});if(e.type!=="change")$(this).trigger("change")}});if(true)this.widget.find("#imei").inputmask("999999-99-999999-9",{disablePredictiveText:true});this.widget.find("#countryId").change(function(){var c=$("#countryId").val()*1;if(c)$.ajax({url:"/"+language+"/dashboard/get-online-service-network?countryId="+c,cache:false,async:true,complete:function(xhr){var networks=$.parseJSON(xhr.responseText);if(networks&&networks!==null&&networks.length){var options=emptyOption;$.each(networks,function(n,network){options+='<option value="'+network.network_id+'">'+network.network_name+"</option>"});self.widget.find("#networkId").html(options).val(0).trigger("change");self.widget.find("#networkRow").removeClass("hidden");chimeraApplication.layoutManager.updateAll()}else{self.widget.find("#networkId").html(emptyOption).val(0).trigger("change");self.widget.find("#networkRow").addClass("hidden");chimeraApplication.layoutManager.updateAll()}}});else{self.widget.find("#networkId").html(emptyOption).val(0).trigger("change");self.widget.find("#networkRow").addClass("hidden");chimeraApplication.layoutManager.updateAll()}});this.widget.find("#brandId, #countryId, #networkId").change(function(){var c=$("#countryId").val()*1;var b=$("#brandId").val()*1;var n=$("#networkId").val()*1;if(c&&b&&n)$.ajax({url:"/"+language+"/dashboard/get-online-service-model?countryId="+c+"&brandId="+b+"&networkId="+n,cache:false,async:true,complete:function(xhr){var models=$.parseJSON(xhr.responseText);if(models&&models!==null&&models.length){needModel=true;var options=emptyOption;$.each(models,function(m,model){options+='<option value="'+model.model_id+'">'+model.model_name+"</option>"});self.widget.find("#modelId").html(options).val(0).trigger("change");self.widget.find("#modelRow").removeClass("hidden");chimeraApplication.layoutManager.updateAll()}else{needModel=false;self.widget.find("#modelId").html(emptyOption).val(0).trigger("change");self.widget.find("#modelRow").addClass("hidden");chimeraApplication.layoutManager.updateAll()}}});else{needModel=false;self.widget.find("#modelId").html(emptyOption).val(0).trigger("change");self.widget.find("#modelRow").addClass("hidden");chimeraApplication.layoutManager.updateAll()}});this.widget.find("#brandId, #countryId, #networkId, #modelId").change(function(){var c=$("#countryId").val()*1;var b=$("#brandId").val()*1;var n=$("#networkId").val()*1;var m=$("#modelId").val()*1;if(c&&b&&n&&(m||!needModel)){self.widget.find("#imei").trigger("change");self.widget.find("#imeiRow").removeClass("hidden");chimeraApplication.layoutManager.updateAll()}else{self.widget.find("#imei").val("").trigger("change");self.widget.find("#imeiRow").addClass("hidden");chimeraApplication.layoutManager.updateAll()}});this.widget.find("#brandId, #countryId, #networkId, #modelId, #imei").change(function(){var imei=$("#imei");var c=$("#countryId").val()*1;var b=$("#brandId").val()*1;var n=$("#networkId").val()*1;var m=$("#modelId").val()*1;var e=imei.val();var i=e.replace(/[^0-9]/gi,"");if(c&&b&&n&&(m||!needModel)&&i&&i.length==15)if(!self.luhnValidate(i))self.widget.find(".error-box").html(luhnCheckText);else{self.widget.find(".error-box").html("");self.getPrice(c,b,n,m,i)}else self.widget.find(".error-box").html("");chimeraApplication.layoutManager.updateAll()});this.widget.find(".cancel").click(function(){self.widget.find(".error-box, .info-box, .success-box").html("");self.widget.find("input, select").removeClass("disabled").prop("disabled",false).val(0);self.widget.find(".unlock").addClass("disabled").prop("disabled",true);self.widget.find(".cancel").addClass("hidden");self.widget.find("#imei").val("");self.widget.find("#imei").val("");self.widget.find("#networkRow, #modelRow, #imeiRow").addClass("hidden");chimeraApplication.layoutManager.updateAll()});this.widget.find(".unlock").click(function(){if(!$(this).hasClass("disabled")){var imei=$("#imei");var c=$("#countryId").val()*1;var b=$("#brandId").val()*1;var n=$("#networkId").val()*1;var m=$("#modelId").val()*1;var e=imei.val();var i=e.replace(/[^0-9]/gi,"");self.unlock(c,b,n,m,i)}})},getPrice:function(c,b,n,m,i){var self=this;this.widget.find("input, select, .unlock").addClass("disabled").prop("disabled",true);$.ajax({url:"/dashboard/get-online-service-price",type:"GET",data:{brandId:b*1,countryId:c*1,networkId:n*1,modelId:m*1,imei:i},async:true,cache:false,complete:function(xhr){var response=$.parseJSON(xhr.responseText);if(response.success){self.widget.find(".unlock").removeClass("disabled").prop("disabled",false);self.widget.find(".cancel").removeClass("hidden");self.widget.find(".error-box, .success-box").html("");self.widget.find(".info-box").html(response.message)}else{self.widget.find("input, select").removeClass("disabled").prop("disabled",false);self.widget.find(".info-box, .success-box").html("");self.widget.find(".error-box").html(response.error)}}})},unlock:function(c,b,n,m,i){var self=this;this.widget.find(".unlock").addClass("disabled").prop("disabled",true);this.widget.find(".cancel").addClass("hidden");$.ajax({url:"/dashboard/checkout-online-service-nck",type:"GET",data:{brandId:b*1,countryId:c*1,networkId:n*1,modelId:m*1,imei:i},async:true,cache:false,complete:function(xhr){self.widget.find(".cancel").trigger("click");var response=$.parseJSON(xhr.responseText);if(response.success)self.widget.find(".success-box").html(response.message);else self.widget.find(".error-box").html(response.error)}})}});Chimera.DashboardImeiBlackListCheck=new JS.Class(Chimera.DashboardWidget,{widgetHistory:null,widget:null,initialize:function(attributes){this.callSuper(attributes);this.widget=$(".widget-imeiBlackListCheck:not(.widget-imeiHistory )");this.widgetHistory=$(".widget-imeiBlackListCheck.widget-imeiHistory");var self=this;var freeImeiRow=this.widget.find("#freeImeiRow");var paidImeiRow=this.widget.find("#paidImeiRow");var useCredits=this.widget.find("#useCredits");freeImeiRow.click(function(e){if(!freeImeiRow.hasClass("-inactive")){freeImeiRow.addClass("-active");paidImeiRow.removeClass("-active");useCredits.val("0")}e.stopPropagation();return false});paidImeiRow.click(function(e){if(!paidImeiRow.hasClass("-inactive")){paidImeiRow.addClass("-active");freeImeiRow.removeClass("-active");useCredits.val("1")}e.stopPropagation();return false});this.widget.find("#checkImei").on("keydown keyup change blur",function(e){if(!e.keyCode||parseInt(e.keyCode)!==8){var value=$(this).val().split("-");var num=(value[0]+value[1]+value[2]).replace(/[^0-9]/gi,"");$(this).inputmask("999999-99-999999-"+
self.luhnCalculate(num),{disablePredictiveText:true})}});this.widget.find("#checkImei").inputmask("999999-99-999999-9",{disablePredictiveText:true});this.widget.find("input").change(function(){var checkForm=self.widget.find(".check-form");var input=$("#checkImei");var checkbox=$("#acceptImei");var button=checkForm.find(".button");var valid=true;var imei=input.val().replace(/[^0-9]/gi,"");if(imei.length===15)if(self.luhnValidate(imei))checkForm.find(".error-box").html("");else{checkForm.find(".error-box").html(luhnCheckText);valid=false}else{checkForm.find(".error-box").html("");valid=false}if(!checkbox.is(":checked"))valid=false;if(valid)button.removeClass("disabled").prop("disabled",false);else button.addClass("disabled").prop("disabled",false)});self.widget.find(".check-form .button").click(function(){if(!$(this).hasClass("disabled")){var input=$("#checkImei");var imei=input.val().replace(/[^0-9]/gi,"");self.widget.find(".check-form").hide();if(!useCredits.length||useCredits.val()==="1"){self.widget.find(".check-confirm").show();self.widget.find(".confirm-imei").html(imei)}else self.widget.find(".check-confirm .button.yes").trigger("click");chimeraApplication.layoutManager.updateAll()}});var yes=window.commonYes;var no=window.commonNo;var getValueNA=function(value){return!value||value.toUpperCase()==="NA"||value.toUpperCase()==="N/A"?"&mdash;":value};var getYesNoValue=function(value){if(value&&(value+"").toLowerCase()==="yes")return'<span class="il-m badge green">'+yes+"</span>";if(value&&(value+"").toLowerCase()==="no")return'<span class="il-m badge">'+
no+"</span>";return getValueNA(value)};var getYesNoBadge=function(value){if(value)return'<span class="il-m badge red">'+yes+"</span>";return'<span class="il-m badge green">'+no+"</span>"};self.widget.find(".check-confirm .button").click(function(){var button=$(this);if(button.hasClass("no")){self.widget.find(".check-confirm").hide();self.widget.find(".confirm-imei").html("");self.widget.find(".check-form").show();chimeraApplication.layoutManager.updateAll()}else{var input=$("#checkImei");var imei=input.val().replace(/[^0-9]/gi,"");var buttons=self.widget.find(".check-confirm .button");buttons.addClass("disabled").prop("disabled",true);var url="/dashboard/check-imei?imei="+imei;if(useCredits.length)url+="&useCredits="+useCredits.val();else url+="&useCredits=1";$.ajax({url:url,cache:false,async:true,complete:function(xhr){self.widget.find(".check-confirm").hide();self.widget.find(".check-results").show();buttons.removeClass("disabled").prop("disabled",false);var response=$.parseJSON(xhr.responseText);if(response.success){if(typeof response.balance!=="undefined"&&typeof response.absoluteBalance!=="undefined"){if(response.balance<=0){freeImeiRow.addClass("-inactive");paidImeiRow.trigger("click")}freeImeiRow.find(".available strong").html("<em>"+response.balance+"</em>/"+response.absoluteBalance)}var res=response.result;var old=typeof res.result.devicetype==="undefined";self.widget.find(old?".old":".new").show();self.widget.find(old?".new":".old").hide();self.widget.find(".data-imei").html(res.imei);self.widget.find(".data-result .badge").addClass("hidden");self.widget.find(".data-result .badge."+(res.blocked?"red":"green")).removeClass("hidden");self.widget.find(".data-make").html(getValueNA(old?res.result.make:res.result.brandname));self.widget.find(".data-model").html(getValueNA(res.result.model));if(!old){self.widget.find(".data-devicetype").html(getValueNA(res.result.devicetype));self.widget.find(".data-operatingsys").html(getValueNA(res.result.operatingsys));self.widget.find(".data-wlan").html(getYesNoValue(res.result.WLAN));self.widget.find(".data-bluetooth").html(getYesNoValue(res.result.bluetooth));self.widget.find(".data-nfc").html(getYesNoValue(res.result.nfc))}console.dir(self.widget.find(".data-result"));if(res.result&&res.result.result)self.widget.find(".data-result").html(res.result.result).parent().show();else self.widget.find(".data-result").html("").parent().hide();var checks=["network_block","grey_list","police_lost_property","owner_temp_block","expired_owner_temp_block","insurance","recycled_previously"];$.each(checks,function(c,check){if(typeof res.result[check]!=="undefined")self.widget.find(".data-"+check).html(getYesNoBadge(res.result[check]))});self.widget.find(".check-results .error-box").html("");self.widget.find(".check-results .results").show()}else{self.widget.find(".check-results .error-box").html(response.error);self.widget.find(".check-results .results").hide()}chimeraApplication.layoutManager.updateAll()}})}});self.widget.find(".check-results .button").click(function(){self.widget.find(".check-results").hide();self.widget.find(".check-confirm").hide();self.widget.find(".confirm-imei").html("");self.widget.find(".check-form").show();$("#checkImei").val("").focus();self.widget.find("input").trigger("change");self.widget.find("#acceptImei").prop("checked",false);chimeraApplication.layoutManager.updateAll()});$(".widget-imeiHistory .button").click(function(){var button=$(this);var td=button.parent();var tr=td.parent();var next=tr.next();var data=button.data("log");data=window.checkLog[data]||null;if(data){var old=typeof data.response.devicetype==="undefined";next.find(old?".old":".new").show();next.find(old?".new":".old").hide();next.find(".data-imei").html(data.imei);next.find(".data-result .badge").addClass("hidden");next.find(".data-result .badge."+(data.blocked?"red":"green")).removeClass("hidden");next.find(".data-make").html(getValueNA(old?data.response.make:data.response.brandname));next.find(".data-model").html(getValueNA(data.response.model));if(!old){next.find(".data-devicetype").html(getValueNA(data.response.devicetype));next.find(".data-operatingsys").html(getValueNA(data.response.operatingsys));next.find(".data-wlan").html(getYesNoValue(data.response.WLAN));next.find(".data-bluetooth").html(getYesNoValue(data.response.bluetooth));next.find(".data-nfc").html(getYesNoValue(data.response.nfc))}var checks=["network_block","grey_list","police_lost_property","owner_temp_block","expired_owner_temp_block","insurance","recycled_previously"];$.each(checks,function(c,check){if(typeof data.response[check]!=="undefined")next.find(".data-"+
check).html(getYesNoBadge(data.response[check]))})}td.find(".button.hidden").toggleClass("hidden");button.toggleClass("hidden");next.toggleClass("hidden");$(window).scrollTo(next,{duration:500,axis:"y",offset:-160})})}});Chimera.DashboardCreditTransfer=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){var minAmount=1;this.callSuper(attributes);var widget=$(".widget-creditTransfer");widget.find("#amount").on("change",function(){var input=$(this);var value=input.val()*1;value=isNaN(value)?minAmount:value;value=Math.max(minAmount,value);value=Math.min(1E7,value);input.val(value)});widget.find("#toUserName, #amount").change(function(){var username=widget.find("#toUserName").val();var amount=widget.find("#amount").val()*1;if(username.length&&amount>=minAmount&&!isNaN(amount))widget.find(".button").removeClass("disabled").prop("disabled",false);else widget.find(".button").addClass("disabled").prop("disabled",true)});widget.find("#toUserName").selectize({valueField:"username",labelField:"username",searchField:"username",options:[],create:false,render:{option:function(item,escape){return"<div>"+'<span class="title">'+'<span class="name">'+escape(item.username)+"</span>"+"</span>"+"</div>"}},load:function(query,callback){if(!query.length)return callback();$.ajax({url:"/"+language+"/dashboard/search-user?licence=0&card=0&query="+encodeURIComponent(query),type:"GET",error:function(){alert("Unknown error!");callback()},success:function(xhr){var response=$.parseJSON(xhr);callback(response.data)}})}});widget.find(".button").on("click",function(){if(!$(this).hasClass("disabled")){var params=widget.find("form").serialize();widget.find(".success-box, .error-box").removeClass("animated fadeIn").hide();widget.find(".button, input, select").addClass("disabled").prop("disabled",true);$.ajax({url:"/"+language+"/dashboard/credit-transfer?"+params,async:true,cache:false,complete:function(xhr){var response=$.parseJSON(xhr.responseText);widget.find("input, select").removeClass("disabled").prop("disabled",false);widget.find("#comment").val("");widget.find("#amount").val(minAmount).trigger("change");if(response.error)widget.find(".error-box").show().html(response.message).addClass("animated fadeIn");else widget.find(".success-box").show().html(response.message).addClass("animated fadeIn")}})}})}});Chimera.DashboardResellerHistory=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes);var self=this;$(document.body).on("change","#user, #commentx, #fromDate, #toDate, #type, #filter",function(e){var page=1;self.reloadWidget(page,null,true)});$(document.body).on("click",".widget-resellerHistory .pager a",function(e){var a=$(this);var page=a.data("page");self.reloadWidget(page,null,true);e.stopPropagation();return false});$(document.body).on("click",".widget-resellerHistory .button.gray",function(e){var a=$(this);if(!a.hasClass("disabled")){a.addClass("disabled").prop("disabled",true);var id=a.data("id");var td=$("#comment"+id);td.html('<input type="text" data-id="'+id+'" value="'+td.html().replace(/\"/gi,"'")+'" />');td.find("input").focus()}e.stopPropagation();return false});$(document.body).on("click",".widget-resellerHistory .button.red",function(e){var a=$(this);if(!a.hasClass("disabled")){a.addClass("disabled").prop("disabled",true);var id=a.data("id");$.ajax({url:"/"+language+
"/dashboard/revoke?id="+id,async:true,cache:false,complete:function(xhr){var response=$.parseJSON(xhr.responseText);if(response&&response.message)alert(response.message);self.reloadWidget($(".widget-resellerHistory .pager a.active").data("page"),$(".widget-resellerHistory #filter").val())}})}e.stopPropagation();return false});$(document.body).on("blur",".widget-resellerHistory td input",function(e){var input=$(this);var id=input.data("id");var comment=input.val();input.parent().html(comment);$('a[data-id="'+
id+'"]').removeClass("disabled").prop("disabled",false);$.ajax({url:"/"+language+"/dashboard/edit-comment?id="+id+"&comment="+encodeURIComponent(comment),async:true,cache:false,complete:function(xhr){var response=$.parseJSON(xhr.responseText);if(response&&response.message)alert(response.message)}})})},reloadWidget:function(page,filter,noScroll){var user=$("#user").val();var comment=$("#commentx").val();var fromDate=$("#fromDate").val();var toDate=$("#toDate").val();var type=$("#type").val();var widget=$(".widget-resellerHistory");widget.html('<div class="loader"></div>');if(!noScroll)$(window).scrollTo(widget,{duration:500,offset:-100,axis:"y"});var url="/"+language+"/dashboard/reseller-history?page="+page+(user?"&user="+user:"")+(comment?"&comment="+comment:"")+(fromDate?"&fromDate="+fromDate:"")+(toDate?"&toDate="+toDate:"")+(type?"&type="+type:"");$.ajax({url:url,async:true,cache:false,complete:function(xhr){widget.replaceWith(xhr.responseText)}})}});Chimera.DashboardLicenceActions=new JS.Class(Chimera.DashboardWidget,{licences:{},initialize:function(attributes){this.callSuper(attributes);this.initMixed()},initMixed:function(){var self=this;this.buyRate=0;this.discount=0;this.price=0;this.total=0;this.type="";this.actions=["Sell"];this.widget=$(".widget-licenceActions");this.widget.find(".t0 #to").selectize({valueField:"username",labelField:"username",searchField:"username",options:[],create:false,hideSelected:true,closeAfterSelect:true,render:{option:function(item,escape){return"<div>"+'<span class="title">'+'<span class="name">'+escape(item.username)+"</span>"+"</span>"+"</div>"}},onChange:function(value){self.selectUserOrCard(value,this.options)},load:function(query,callback){if(!query.length)return callback();$.ajax({url:"/"+language+"/dashboard/search-user-mixed?query="+encodeURIComponent(query),type:"GET",error:function(){alert("Unknown error!");callback()},success:function(xhr){var response=$.parseJSON(xhr);if(response&&response.licences)self.licences=response.licences;callback(response.data);if(response.data.length===1)self.widget.find(".t0 #to")[0].selectize.setValue(query.trim())}})}});this.userLicenceId=this.widget.find(".t0 #userLicenceId");this.userLicenceId.change(function(){var select=$(this);var licenceId=select.val()*1;var option=select.find(":selected");var price=option.data("price")*1;var total=option.data("discounted")*1;var discount=(price-total)*-1;self.widget.find(".t0 #price").html(price);self.widget.find(".t0 #discount").html(discount);self.widget.find(".t0 #total").html(total);if(licenceId&&price&&total)self.widget.find(".t0 .button").removeClass("disabled").prop("disabled",false);else self.widget.find(".t0 .button").addClass("disabled").prop("disabled",true);self.updateOptionInfo()});this.widget.find(".t0 #licenceId").change(function(){var select=$(this);var licenceId=select.val()*1;var option=select.find('option[value="'+licenceId+'"]');var price=option.data("price")*1;var total=price;var discount=0;var usernameField=self.widget.find(".t0 #username");var hasUser=usernameField.val().trim().length>0;var specPrice=typeof self.licences[licenceId]!=="undefined"?self.licences[licenceId]:null;if(usernameField.is(":visible")&&specPrice){price=specPrice.originalprice;total=hasUser?specPrice.price:specPrice.originalprice;discount=price-total}self.widget.find(".t0 #price").html(price);self.widget.find(".t0 #discount").html(discount);self.widget.find(".t0 #total").html(total);if(licenceId&&price&&total)self.widget.find(".t0 .button").removeClass("disabled").prop("disabled",false);else self.widget.find(".t0 .button").addClass("disabled").prop("disabled",true)});this.widget.find(".t0 #username").on("change keyup",function(){var select=self.widget.find(".t0 #licenceId");var licenceId=select.val()*1;var option=select.find('option[value="'+licenceId+'"]');var price=option.data("price")*1;var total=price;var usernameField=$(this);var hasUser=usernameField.val().trim().length>0;var specPrice=typeof self.licences[licenceId]!=="undefined"?self.licences[licenceId]:null;if(usernameField.is(":visible")&&specPrice){price=specPrice.originalprice;total=hasUser?specPrice.price:specPrice.originalprice;var discount=price-total;self.widget.find(".t0 #price").html(price);self.widget.find(".t0 #discount").html(discount);self.widget.find(".t0 #total").html(total)}if(licenceId&&price&&total)self.widget.find(".t0 .button").removeClass("disabled").prop("disabled",false);else self.widget.find(".t0 .button").addClass("disabled").prop("disabled",true)});this.widget.find(".t0 #action").change(function(){var select=$(this);var value=select.val();var option=select.find('option[value="'+value+'"]');self.updateLicenceSelects(value);self.widget.find(".t0 .button").html(option.html());var userRow=self.widget.find(".t0 #username").closest(".form-row");userRow.hide();if(self.type==="CARD"&&value==="Sell"&&RESELLER_SELL_USERNAME_ENABLED)userRow.show()});this.widget.find(".t0 .button").on("click",function(e){if(!$(this).hasClass("disabled")){var t0=self.widget.find(".t0");var action=self.widget.find("#action").val().toLowerCase();var to=t0.find("#userLicenceId").find(":selected").data("to");var params=action==="sell"?"to="+t0.find("#to").val()+"&type="+self.type+"&licenceId="+t0.find("#licenceId").val()+(self.type==="CARD"?"&username="+t0.find("#username").val():""):"id="+t0.find("#userLicenceId").val()+(to?"&to="+to:"");t0.find(".success-box, .error-box").removeClass("animated fadeIn").hide();t0.find(".button, input, select").addClass("disabled").prop("disabled",true);$.ajax({url:"/"+language+"/dashboard/licence-"+action+
"?"+params,async:true,cache:false,complete:function(xhr){var response=$.parseJSON(xhr.responseText);t0.find("input, select").removeClass("disabled").prop("disabled",false);if(response.error)t0.find(".error-box").show().html(response.message).addClass("animated fadeIn");else{self.price=0;self.total=0;self.discount=0;t0.find("#to")[0].selectize.clear();t0.find("#to").val("").trigger("change");t0.find("#username").val("").closest(".form-row").hide();self.updatePrices();self.updateHistory();t0.find(".success-box").show().html(response.message).addClass("animated fadeIn")}}})}e.stopPropagation();return false})},updateOptionInfo:function(){var action=this.widget.find(".t0 #action").val();var info="";var infoLine=this.widget.find(".eu-info-line").hide();if(this.cardInfo&&this.cardInfo.licence){var fromLicence=this.cardInfo.licence.licenceFriendlyName;var fromExpiry=this.cardInfo.licence.expiry;fromExpiry=fromExpiry.substring(0,4)+"/"+fromExpiry.substring(4,6)+"/"+fromExpiry.substring(6,8);var toLicence="";var toExpiry="";var ix=this.widget.find(".t0 #userLicenceId").val()*1;if(ix>0){ix=this.widget.find('.t0 #userLicenceId option[value="'+
ix+'"]').data("ix")*1;if(!isNaN(ix))switch(action){case "Upgrade":toLicence=this.cardInfo.licence.priceInfo.upgradeInfo.upgrades[ix].licenceFriendlyName;info="Upgrade current "+fromLicence+" to "+toLicence+".";break;case "Extend":toLicence=this.cardInfo.licence.priceInfo.extendInfo.extensions[ix].licenceFriendlyName;toExpiry=this.cardInfo.licence.priceInfo.extendInfo.extensions[ix].extendedExpiry.date;toExpiry=toExpiry.replace(/[^0-9]/gi,"");toExpiry=toExpiry.substring(0,4)+"/"+toExpiry.substring(4,6)+"/"+toExpiry.substring(6,8);if(fromLicence===toLicence)info="Extend current "+fromLicence+" licence expiry from "+fromExpiry+" to "+toExpiry+".";else info="Extend current "+fromLicence+" ("+fromExpiry+") to "+toLicence+" ("+toExpiry+").";break}}}infoLine.html(info);if(info)infoLine.show()},updateLicenceSelects:function(action){switch(action){case "Sell":this.widget.find(".licence-id-row").removeClass("hidden");this.widget.find(".user-licence-id-row").addClass("hidden");break;case "Upgrade":case "Extend":this.widget.find(".licence-id-row").addClass("hidden");this.widget.find(".user-licence-id-row").removeClass("hidden");this.updateUserLicencesSelectOptions(action);break}},updateUserLicencesSelectOptions:function(action){var licences=this.option&&this.option.data&&this.option.data.licences?this.option.data.licences:[];licences=!licences.length?this.option.cardInfo&&this.option.cardInfo.licence?[this.option.cardInfo.licence]:[]:licences;var list=[];$.each(licences,function(l,licence){var subList=[];if(action==="Upgrade"&&licence.priceInfo&&licence.priceInfo.upgradeInfo&&licence.priceInfo.upgradeInfo.isUpgradeable&&licence.priceInfo.upgradeInfo.upgrades)subList=licence.priceInfo.upgradeInfo.upgrades;if(action==="Extend"&&licence.priceInfo&&licence.priceInfo.extendInfo&&licence.priceInfo.extendInfo.isExtendable&&licence.priceInfo.extendInfo.extensions)subList=licence.priceInfo.extendInfo.extensions;$.each(subList,function(i,item){item.licence=licence;list.push(item)})});var options="";var licenceToSelect=null;$.each(list,function(l,item){var licence=item.licence;if(!licenceToSelect)licenceToSelect=licence;var expiry=(item.extendedExpiry&&item.extendedExpiry.date?item.extendedExpiry.date.replace(/[^0-9]+/gi,""):item.extendedExpiry)+"";var expire=expiry.substring(0,4)+"/"+expiry.substring(4,6)+"/"+expiry.substring(6,8);var upgradeTo=action==="Upgrade"&&item.licenceFriendlyName?" \u2192 "+item.licenceFriendlyName:"";var dataTo=action==="Upgrade"&&item.licenceId?' data-to="'+item.licenceId+'"':"";options+='<option data-ix="'+l+'"'+dataTo+' data-price="'+item.fullPrice+'" data-discounted="'+item.discountedPrice+
'" value="'+licence.id+'">'+licence.licenceFriendlyName+upgradeTo+" ("+expire+")"+"</option>"});if(!options.length)options='<option data-price="0" data-discounted="0" value="0">'+(action==="Upgrade"?dbResellerMenuNoUpgradeable:dbResellerMenuNoExtensible)+"</option>";this.userLicenceId.html(options).val(0).trigger("change");if(licenceToSelect)this.userLicenceId.val(licenceToSelect.id).trigger("change")},selectUserOrCard:function(userNameOrCardNumber,options){var sel=this.widget.find(".t0 #to")[0].selectize;sel.loadedSearches={};sel.userOptions={};sel.renderCache={};sel.options=sel.sifter.items={};sel.lastQuery=null;sel.trigger("option_clear");this.widget.find(".eu-info-line").hide();this.widget.find(".t0 .licence-id-row").addClass("hidden");this.widget.find(".t0 .user-licence-id-row").addClass("hidden");this.widget.find(".t0 .button").addClass("disabled").prop("disabled",true);this.widget.find(".t0 #licenceId").val(0);this.widget.find(".t0 #userLicenceId").val(0);var actionRow=this.widget.find(".action-row");var cardInfoLine=this.widget.find("#cardInfoLine");var option=options[userNameOrCardNumber]?options[userNameOrCardNumber]:null;var licence=option&&option.cardInfo&&option.cardInfo.licence?option.cardInfo.licence:null;var upgradeable=false;var extendable=false;if(option&&option.data&&option.data.licences)$.each(option.data.licences,function(l,lic){if(lic.priceInfo&&lic.priceInfo.upgradeInfo&&lic.priceInfo.upgradeInfo.isUpgradeable)upgradeable=true;if(lic.priceInfo&&lic.priceInfo.extendInfo&&lic.priceInfo.extendInfo.isExtendable)extendable=true});this.option=option;this.buyRate=option&&option.data&&option.data.buyRate?option.data.buyRate:0;this.type=option&&option.type?option.type:"";this.cardInfo=option&&option.cardInfo?option.cardInfo:null;this.actions=[];if(this.type&&(this.type!=="CARD"||!licence))this.actions.push("Sell");if(upgradeable)this.actions.push("Upgrade");if(extendable)this.actions.push("Extend");actionRow.addClass("hidden");cardInfoLine.addClass("hidden");if(this.actions.length)actionRow.removeClass("hidden");else if(option&&option.cardInfo&&option.cardInfo.message)cardInfoLine.removeClass("hidden").html(option.cardInfo.message);var actionSelect=this.widget.find(".t0 #action");actionSelect.find("option").hide();for(var a in this.actions)if(this.actions.hasOwnProperty(a))actionSelect.find('option[value="'+this.actions[a]+'"]').show();actionSelect.val(this.actions[0]).trigger("change")},updateHistory:function(){if(this.app.widgets.resellerHistory)this.app.widgets.resellerHistory.reloadWidget($(".widget-resellerHistory .pager a.active").data("page"),$(".widget-resellerHistory #filter").val())},updatePrices:function(){this.discount=Math.floor(this.price*this.buyRate);this.total=this.price-this.discount;this.widget.find(".t0 #price").html(this.price);this.widget.find(".t0 #discount").html(this.discount*-1);this.widget.find(".t0 #total").html(this.total);var to=this.widget.find(".t0 #to").val();if(this.type&&to&&this.price&&this.total&&(!this.cardInfo||!this.cardInfo.licence))this.widget.find(".t0 .button").removeClass("disabled").prop("disabled",false);else this.widget.find(".t0 .button").addClass("disabled").prop("disabled",true)}});Chimera.DashboardImeiAdmin=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes);$(document.body).on("click",".widget-imeiAdmin .button",function(){var button=$(this);var td=button.parent();var tr=td.parent();var next=tr.next();td.find(".button.hidden").toggleClass("hidden");button.toggleClass("hidden");next.toggleClass("hidden");$(window).scrollTo(next,{duration:500,axis:"y",offset:-160})})}});Chimera.DashboardShipping=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes);var self=this;$(document).on("change keyup",".widget-shipping table select, .widget-shipping table input",function(){var cell=$(this).parent().parent();var courierSelect=cell.find("select");var trackingInput=cell.find('input[type="text"]');var button=cell.find(".button");var disabled=trackingInput.val()&&courierSelect.size()&&!courierSelect.val()||!trackingInput.val()&&courierSelect.size()&&courierSelect.val();if(disabled)button.addClass("disabled").prop("disabled",true);else button.removeClass("disabled").prop("disabled",false)});$(document).on("change",".widget-shipping .filter-bar input, .widget-shipping .filter-bar select",function(){self.reloadWidget()});$(document).on("click",".widget-shipping table .button",function(){var button=$(this);if(!button.hasClass("disabled")){var cell=button.parent();var courierSelect=cell.find("select");var trackingInput=cell.find('input[type="text"]');var costInput=cell.find('input[type="number"]');var id=button.data("id");if(id){var data={id:id};if(trackingInput.size()&&trackingInput.val())data.trackingNumber=trackingInput.val();if(costInput.size()){var shippingCost=costInput.val();if(shippingCost!==""){shippingCost=parseInt(shippingCost);if(!isNaN(shippingCost))data.shippingCost=shippingCost}}if(courierSelect.size()&&courierSelect.val())data.courier=courierSelect.val();button.addClass("disabled");button.text(button.text()+"...");dashboardApplication.post("/dashboard/shipping-tracking-number",data,function(response){if(response&&response.response&&response.response.data&&response.response.data.success){if(response.response.data.warning)alert(response.response.data.warning);self.reloadWidget()}else if(response&&response.response&&response.response.errors)alert(response.response.errors.title+" ["+response.response.errors.code+"]");else alert("Unknown error!");button.text(button.text().replace("...",""))})}}})},loadingWidget:false,reloadWidget:function(){if(this.loadingWidget)return;this.loadingWidget=true;var widget=$(".widget-shipping");var page=widget.find(".pager a.active").data("page")*1;page=page?page:1;var tab=widget.find(".tabs .item.active").data("name");var shippingId=widget.find('.filter-bar input[name="shippingId"]').val().trim();var trackingNumber=widget.find('.filter-bar input[name="trackingNumber"]').val().trim();var countryId=widget.find('.filter-bar select[name="countryId"]').val().trim();var url="#shipping?page="+page+(tab?"&tab="+tab:"")+(shippingId?"&shippingId="+window.encodeURIComponent(shippingId):"")+(trackingNumber?"&trackingNumber="+window.encodeURIComponent(trackingNumber):"")+(countryId?"&countryId="+window.encodeURIComponent(countryId):"")+"&_="+Math.random();widget.html('<div class="loader"></div>');window.location.href=url}});Chimera.DashboardShippingDetails=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes);var self=this;$(document).on("change keyup",".widget-shippingDetails select:not(#changeAddressTo), .widget-shippingDetails input",function(){var trackingInput=$("#tracking");var courierSelect=$("#courier");var serialInputs=$("input.serials");var button=$(".widget-shippingDetails .button.save");var hasSerial=false;var serialsOk=true;if(serialInputs.size())$.each(serialInputs,function(s,serialInput){var serial=$(serialInput).val();if(serial)hasSerial=true;else if(hasSerial)serialsOk=false});var disabled=trackingInput.val()&&courierSelect.size()&&!courierSelect.val()||!trackingInput.val()&&courierSelect.size()&&courierSelect.val();if(disabled)button.addClass("disabled").prop("disabled",true);else button.removeClass("disabled").prop("disabled",false)});$(document).on("click",".widget-shippingDetails .button.destroy",function(e){var button=$(this);if(window.confirm(button.data("question")))self.actionDestroy(button,button.data("id")*1);e.stopPropagation();return false});$(document).on("click",".widget-shippingDetails .button.save",function(){var button=$(this);if(!button.hasClass("disabled")){var trackingInput=$("#tracking");var courierSelect=$("#courier");var costInput=$("#cost");var serialInputs=$("input.serials");var id=button.data("id");if(id){var data={id:id};var serialList={};var hasSerial=false;if(trackingInput.size()&&trackingInput.val())data.trackingNumber=trackingInput.val();if(costInput.size()){var shippingCost=costInput.val();if(shippingCost!==""){shippingCost=parseInt(shippingCost);if(!isNaN(shippingCost))data.shippingCost=shippingCost}}if(courierSelect.size()&&courierSelect.val())data.courier=courierSelect.val();if(serialInputs.size())$.each(serialInputs,function(s,serialInput){var serial=$(serialInput).val();if(serial)hasSerial=true;var itemId=$(serialInput).data("item-id")*1;if(!serialList[itemId])serialList[itemId]=[];serialList[itemId].push(serial)});data.serials=serialList;button.addClass("disabled");button.text(button.text()+"...");dashboardApplication.post("/dashboard/shipping-tracking-number",data,function(response){if(response&&response.response&&response.response.data&&response.response.data.success){if(response.response.data.warning)alert(response.response.data.warning);self.reloadWidget(id)}else if(response&&response.response&&response.response.errors)alert(response.response.errors.title+(response.response.errors.code?" ["+response.response.errors.code+"]":""));else{alert("Unknown error!");console.dir(response)}button.text(button.text().replace("...",""))})}}});$(document).on("change","#shippingPreset",function(){var select=$(this);var option=select.find('option[value="'+select.val()+'"]');$("#shippingSubject").val(option.data("subject"));$("#shippingMessage").val(option.data("message"))});$(document).on("change keyup",".shipping-messages-form input, .shipping-messages-form select, .shipping-messages-form textarea",function(){var subject=$("#shippingSubject").val().trim();var message=$("#shippingMessage").val().trim();var button=$(".shipping-messages-form .button");button.removeClass("disabled").prop("disabled",false).removeAttr("disabled");if(!subject.length||!message.length)button.addClass("disabled").prop("disabled",true).attr("disabled","disabled")});$(document).on("click",".shipping-messages-form .button",function(e){var button=$(this);var prevButtonText=button.html();if(button.hasClass("disabled")){e.stopPropagation();return false}else button.addClass("disabled").prop("disabled",true).attr("disabled","disabled").html('<i class="fa fa-refresh fa-spin"></i>');var data={message:JSON.stringify({shippingId:parseInt($("#shippingId").val()),type:0,subject:$("#shippingSubject").val().trim(),message:$("#shippingMessage").val().trim(),userEmail:$("#shippingTo").val().trim(),userLanguage:$("#shippingLanguage").val().trim()})};self.app.post("/"+language+"/dashboard/send-shipping-message",data,function(response){$(".shipping-messages-list").replaceWith(response.messages);$("#shippingPreset").val(0).trigger("change");button.html(prevButtonText)})});$(document).on("change","#changeAddressTo",function(){var select=$(this);var button=$(".button.change-address");var targetId=parseInt(select.val());targetId=isNaN(targetId)?0:targetId;if(targetId)button.removeClass("disabled").removeAttr("disabled").prop("disabled",false);else button.addClass("disabled").attr("disabled","disabled").prop("disabled",true)});$(document).on("click",".button.change-address",function(e){var button=$(this);if(!button.hasClass("disabled")){var select=$("#changeAddressTo");var sourceId=parseInt(button.data("id"));sourceId=isNaN(sourceId)?0:sourceId;var targetId=parseInt(select.val());targetId=isNaN(targetId)?0:targetId;if(sourceId&&targetId){select.addClass("disabled").attr("disabled","disabled").prop("disabled",true);button.addClass("disabled").attr("disabled","disabled").prop("disabled",true);$.ajax({url:"/"+language+"/dashboard/change-address?sourceId="+sourceId+"&targetId="+targetId,async:true,cache:false,complete:function(xhr){var response=$.parseJSON(xhr.responseText);alert(response.message);if(response.success)window.location.reload();else select.removeClass("disabled").removeAttr("disabled").prop("disabled",false).val(0).trigger("change")}})}}e.stopPropagation();return false})},reloadWidget:function(id){var widget=$(".widget-shippingDetails");widget.html('<div class="loader"></div>');$.ajax({url:"/"+language+"/dashboard/shipping-details?id="+id,async:true,cache:false,complete:function(xhr){widget.parent().parent().replaceWith(xhr.responseText)}})},actionDestroy:function(button,id){var btn=$(button);if(btn.hasClass("disabled"))return;btn.addClass("disabled").attr("disabled","disabled").prop("disabled",true);$.ajax({url:"/"+language+"/dashboard/destroy-shipping?id="+id,async:true,cache:false,complete:function(xhr){var response=$.parseJSON(xhr.responseText);if(response.success)btn.replaceWith("");else btn.removeClass("disabled").removeAttr("disabled").prop("disabled",false);alert(response.message)}})}});Chimera.DashboardPartnerAdmin=new JS.Class(Chimera.DashboardWidget,{cssPrefix:".widget-partnerAdmin ",urlPrefix:"#partner-admin",initialize:function(attributes){this.callSuper(attributes);var self=this;$(window).on("load",function(){self.updateFilterForm("search");self.updateFilterForm("csv")}).on("resize",function(){self.updateFilterForm("search");self.updateFilterForm("csv")}).on("orientationchange",function(){self.updateFilterForm("search");self.updateFilterForm("csv")});this.updateFilterForm("search");this.updateFilterForm("csv");this.initializeAutoExtendToggle();this.initializeClearComputerBindings();this.initializeExtendLicenceExpiry();$(this.cssPrefix+".filter-form.csv input").change(function(){var inp=$(this);var col=$(self.cssPrefix+".filter-form.csv .upload-col");if(inp.val()){inp.parent().find(".button").addClass("gray");col.show().removeClass("fadeOut").addClass("fadeIn")}else{inp.parent().find(".button").removeClass("gray");col.removeClass("fadeIn").addClass("fadeOut");setTimeout(function(){col.hide()},1E3)}})},runSearch:function(){var url=this.urlPrefix+"?page=1";$(this.cssPrefix+".filter-form.search input, "+this.cssPrefix+".filter-form.search select").each(function(e,element){var input=$(element);var value=input.val();var name=input.attr("name");if(value)url+="&"+name+"="+window.encodeURIComponent(value)});window.location.href=url},clearSearch:function(){$(this.cssPrefix+".filter-form input").val("");$(this.cssPrefix+".filter-form select").val(0);this.runSearch()},updateFilterForm:function(postfix){var filterForm=$(this.cssPrefix+".filter-form."+postfix);var filterFormInner=filterForm.find(".filter-form-inner");if(filterForm.hasClass("hidden"))filterForm.css("max-height",0);else filterForm.css("max-height",filterFormInner.height())},toggleFilterForm:function(postfix,notRun){if(!notRun&&!$(this.cssPrefix+".filter-form:not(."+postfix+")").hasClass("hidden"))this.toggleFilterForm(postfix=="csv"?"search":"csv",true);$(this.cssPrefix+".filter-button:not(."+postfix+")").removeClass("pushed");$(this.cssPrefix+".filter-form."+
postfix).toggleClass("hidden fadeIn fadeOut");$(this.cssPrefix+".filter-button."+postfix).toggleClass("pushed");this.updateFilterForm(postfix)},initializeAutoExtendToggle:function(){var self=this;$(this.cssPrefix+".toggle-autoExtend").click(function(){var button=$(this);var userId=button.data("id");var autoExtend=button.hasClass("red")?0:1;self.getExtendPrice(userId,function(price){if(window.confirm(window["autoExtendConfirm"+autoExtend].replace("{amount}",price+"")))$.ajax({url:"/dashboard/partner-toggle-auto-extend?userId="+
userId+"&autoExtend="+autoExtend,cache:false,async:true,complete:function(xhr){var response=$.parseJSON(xhr.responseText);if(response.success)dashboardApplication.routing(true);else console.warn(response.error)}})})})},initializeClearComputerBindings:function(){$(this.cssPrefix+".clear-bindings").click(function(){var button=$(this);var userId=button.data("id");if(window.confirm(clearBindingsConfirm))$.ajax({url:"/dashboard/partner-clear-computer-bindings?userId="+userId,cache:false,async:true,complete:function(xhr){var response=$.parseJSON(xhr.responseText);if(response.success)dashboardApplication.routing(true);else console.warn(response.error)}})})},initializeExtendLicenceExpiry:function(){var self=this;$(this.cssPrefix+".extend-expiry").click(function(){var button=$(this);var userId=button.data("id");self.getExtendPrice(userId,function(price){if(window.confirm(extendExpiryConfirm.replace("{amount}",price+"")))$.ajax({url:"/dashboard/partner-extend-licence-expiry?userId="+userId,cache:false,async:true,complete:function(xhr){var response=$.parseJSON(xhr.responseText);if(response.success)dashboardApplication.routing(true);else console.warn(response.error)}})})})},getExtendPrice:function(userId,callback){$.ajax({url:"/"+language+"/dashboard/partner-get-user/"+userId,cache:false,async:true,complete:function(xhr){var user=$.parseJSON(xhr.responseText);var price=0;if(user.extendInfo&&user.extendinfo.extensions&&user.extendInfo.extensions[0]&&user.extendInfo.extensions[0].discountedPrice)price=user.extendInfo.extensions[0].discountedPrice;if(price==0&&user.buyInfo&&user.buyInfo.discountedPrice)price=user.buyInfo.discountedPrice;callback(price)}})}});Chimera.DashboardPartnerWorks=new JS.Class(Chimera.DashboardPartnerAdmin,{cssPrefix:".widget-partnerWorks ",urlPrefix:"#partner-works",initialize:function(attributes){this.callSuper(attributes)}});Chimera.DashboardPartnerDownload=new JS.Class(Chimera.DashboardPartnerAdmin,{cssPrefix:".widget-partnerDownload ",urlPrefix:"#partner-download",initialize:function(attributes){this.callSuper(attributes)}});Chimera.DashboardPartnerUser=new JS.Class(Chimera.DashboardWidget,{cssPrefix:".widget-partnerUser ",urlPrefix:"#partner-user",initialize:function(attributes){this.callSuper(attributes);var self=this;$(this.cssPrefix+"#timezone").selectize({});$(this.cssPrefix+".button.submit").click(function(){$(self.cssPrefix+".success-box, "+self.cssPrefix+".error-box").removeClass("animated fadeIn").hide();var data=$("#partnerUserForm").serializeObject();self.app.post("/"+language+"/dashboard/partner-save-user",data,function(response){if(response.error)$(self.cssPrefix+".error-box").show().html(response.message).addClass("animated fadeIn");else{$(self.cssPrefix+".success-box").show().html(response.message).addClass("animated fadeIn");window.history.back()}})})}});Chimera.DashboardUserSessions=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes);var self=this;var widget=$(".widget-userSessions");console.dir(widget)},deleteSession:function(sessionId,button,isFrontend){$(button).addClass("animated fadeOut");$.ajax({url:"/dashboard/delete-session?sessionId="+sessionId+"&frontend="+(isFrontend?"1":"0"),cache:false,async:true,complete:function(response){var tr=isFrontend?$(button).parent().parent():$(button).parent().parent().parent();tr.addClass("animated fadeOut");setTimeout(function(){tr.hide()},900)}})}});Chimera.DashboardTaskForm=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes);var self=this;var commentButton=$(".widget-taskForm .submit.comment");var submitButton=$(".widget-taskForm .submit.save");var commentText="";var descriptionText="";var titleText="";var textValues={title:"",description:""};var updateCommentText=function(id){id=(id||"comment")+"";var text=$("#"+id).html();if(text.trim)text=text.trim();if(id==="comment"){commentText=text;var commentTextValue=text.replace(/(<([^>]+)>)/ig,"");if(commentTextValue.trim)commentTextValue.trim();if(commentTextValue.length)commentButton.removeClass("disabled").prop("disabled",false);else commentButton.addClass("disabled").prop("disabled",true)}else{if(id==="description")descriptionText=text;titleText=$("#title").val();if(titleText.trim)titleText=titleText.trim();textValues[id]=id==="title"?titleText:text.replace(/(<([^>]+)>)/ig,"");if(textValues[id].trim)textValues[id].trim();if(textValues.description.length>=30&&textValues.title.length)submitButton.removeClass("disabled").prop("disabled",false);else submitButton.addClass("disabled").prop("disabled",true)}};submitButton.click(function(){if($(this).hasClass("disabled"))return false;$("#task-content").val(descriptionText);$("#task-form").submit();return true});$("#task-form").submit(function(){$("#description-content").val(descriptionText);$("#task-form").hide();$("#task-saving").show();return true});commentButton.click(function(){if($(this).hasClass("disabled"))return false;$("#comment-content").val(commentText);$("#comment-form").submit().hide();$("#comment-saving").show()});$(".widget-taskForm #comment-file").change(function(){var size=this.files&&this.files[0]&&this.files[0].size?this.files[0].size:0;size=size/1024/1024;if(MAX_FILE_SIZE&&size>MAX_FILE_SIZE)alert("Maximum allowed files size is: "+MAX_FILE_SIZE+"MB!");else{var input=$(this);var value=input.val();value=(value?value+"":"").split("\\");value=value[value.length-1].split("/");value=value[value.length-1];$("#comment-form .wysiwyg-file .f-name").html(value);if(value)$("#comment-form .wysiwyg-file").removeClass("hidden");else $("#comment-form .wysiwyg-file").addClass("hidden")}});$("#comment-form .wysiwyg-file .f-delete").click(function(){$(".widget-taskForm #comment-file").val("").trigger("change")});$(".widget-taskForm #description-file").change(function(){var input=$(this);var value=input.val();value=(value?value+"":"").split("\\");value=value[value.length-1].split("/");value=value[value.length-
1];$("#task-form .wysiwyg-file .f-name").html(value);if(value)$("#task-form .wysiwyg-file").removeClass("hidden");else $("#task-form .wysiwyg-file").addClass("hidden")});$("#task-form .wysiwyg-file .f-delete").click(function(){$(".widget-taskForm #description-file").val("").trigger("change")});$(".widget-taskForm .submit.close").click(function(){var button=$(this);if(!window.confirm(button.data("question")))return false;var id=parseInt(button.data("id"));self.app.post("/"+language+"/dashboard/close-task",{id:id},function(response){if(response.error)alert(response.message);else window.location.href="/#tasks"})});var element=document.getElementById("comment");if(element)element.addEventListener("paste",function(e){e.preventDefault();var text=e.clipboardData.getData("text/plain");document.execCommand("insertHTML",false,text)});$("#comment").wysiwygEvt().change(function(){updateCommentText()});var elementDescription=document.getElementById("description");if(elementDescription)elementDescription.addEventListener("paste",function(e){e.preventDefault();var text=e.clipboardData.getData("text/plain");document.execCommand("insertHTML",false,text)});var description=$("#description");description.wysiwygEvt().change(function(){updateCommentText("description")});$("#title").change(function(){updateCommentText("title")});if(description.size()){updateCommentText("title");updateCommentText("description")}},format:function(command){document.execCommand(command,false,null)}});(function($){$.fn.wysiwygEvt=function(){return this.each(function(){var $this=$(this);var htmlOld=$this.html();$this.bind("blur keyup paste copy cut mouseup",function(){var htmlNew=$this.html();if(htmlOld!==htmlNew){$this.trigger("change");htmlOld=htmlNew}})})}})(jQuery);Chimera.DashboardPaypalAgreementHistory=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes)},cancel:function(id,question){if(window.confirm(question)){var self=this;$.ajax({url:"/"+language+"/dashboard/cancel-paypal-agreement?agreementId="+id,type:"GET",failed:function(){alert("Server error. Try again later!")},success:function(response){response=$.parseJSON(response);if(response.success)self.reload();else alert(response.message)}})}return false},reload:function(){var widget=$(".widget-paypalAgreementHistory");widget.html('<div class="loader"></div>');$.ajax({url:"/"+language+"/dashboard/paypal-agreement-history",async:true,cache:false,complete:function(xhr){widget.parent().parent().replaceWith(xhr.responseText)}})}});Chimera.DashboardPaddleSubscriptionHistory=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes)},cancel:function(cancelUrl,question){console.dir(Paddle);Paddle.Checkout.open({locale:paddleLanguages[language],override:cancelUrl});return false},update:function(updateUrl){Paddle.Checkout.open({locale:paddleLanguages[language],override:updateUrl});return false},reload:function(){var widget=$(".widget-paddleSubscriptionHistory");widget.html('<div class="loader"></div>');$.ajax({url:"/"+language+"/dashboard/paddle-subscription-history",async:true,cache:false,complete:function(xhr){widget.parent().parent().replaceWith(xhr.responseText)}});var paddleFrame=$(".paddle-frame");paddleFrame.css("transition","opacity 0.5s ease-out").css("opacity","0");setTimeout(function(){paddleFrame.replaceWith("")},500)}});Chimera.DashboardJobHistory=new JS.Class(Chimera.DashboardWidget,{cssPrefix:".widget-jobHistory ",urlPrefix:"#job-history",initialize:function(attributes){this.callSuper(attributes);this.initWidget()},initWidget:function(){var self=this;var ids=[];var hideButton=$(this.cssPrefix+".hide-button");var searchButton=$(this.cssPrefix+".search-button");var workLogButtons=$(this.cssPrefix+".work-log-button");var pagerLink=$(this.cssPrefix+".pager a");$("body > .log-window-wrapper").replaceWith("");$(".log-window-wrapper").appendTo("body");$(this.cssPrefix+".checkbox").click(function(){$(this).toggleClass("checked");ids=[];$.each($(self.cssPrefix+".checkbox"),function(c,checkbox){checkbox=$(checkbox);if(checkbox.hasClass("checked"))ids.push(parseInt(checkbox.data("id")))});hideButton.removeClass("red").addClass("disabled").prop("disabled",true).attr("disabled","disabled");if(ids.length)hideButton.addClass("red").removeClass("disabled").prop("disabled",false).removeAttr("disabled")});hideButton.click(function(e){if(!$(this).hasClass("disabled"))$.ajax({url:"/"+
language+"/dashboard/hide-jobs?ids="+ids.join(","),method:"GET",cache:false,async:true,success:function(){self.reloadWidget(true)}});e.stopPropagation();return false});searchButton.click(function(e){self.reloadWidget(false);e.stopPropagation();return false});pagerLink.click(function(e){var compact=parseInt($("#compact").val());compact=isNaN(compact)?0:compact;if(compact){self.reloadWidget(false,$(this).data("page"));e.stopPropagation();return false}});workLogButtons.click(function(e){var elem=$(this);elem.html('<i class="il-m fa fa-fw fa-cog fa-spin"></i>');$.ajax({url:elem.attr("href"),method:"GET",cache:false,complete:function(xhr){if(xhr&&xhr.responseText)self.showWindow(xhr.responseText);elem.html('<i class="il-m fa fa-fw fa-info"></i>');$(".log-window .log-title span").html(elem.data("id"))}});e.stopPropagation();return false});$(".log-window .log-title a").click(function(e){self.hideWindow();e.stopPropagation();return false});$("#modelCategoryId").change(function(e){self.categoryChanged()});this.categoryChanged()},categoryChanged:function(){var categoryId=parseInt($("#modelCategoryId").val());categoryId=isNaN(categoryId)?0:categoryId;var options=$(".to-filter option");options.show();if(categoryId)$.each(options,function(o,option){var o=$(option);var c=parseInt(o.data("category"));if(c&&c!==categoryId){o.hide();if(o.is(":selected"))o.parent().val(0)}})},reloadWidget:function(keepPage,page){var self=this;var widget=$(this.cssPrefix);var params=this.getFilterParams(keepPage,page);var compact=parseInt($("#compact").val());compact=isNaN(compact)?0:compact;widget.html('<div class="loader"></div>');$.ajax({url:"/"+language+"/dashboard/job-history"+params,async:true,cache:false,complete:function(xhr){if(compact)widget.replaceWith(xhr.responseText);else widget.parent().parent().replaceWith(xhr.responseText);self.initWidget()}})},getFilterParams:function(keepPage,p){var page=p;if(typeof p==="undefined"){page=$(this.cssPrefix+".pager a.active").data("page")*1;page=page?page:1;page=keepPage?page:1}var compact=parseInt($("#compact").val());compact=isNaN(compact)?0:compact;var limit=parseInt($("#limit").val());limit=isNaN(limit)?50:limit;var workId=parseInt($("#workId").val());workId=isNaN(workId)?0:workId;var status=parseInt($("#status").val());status=isNaN(status)?0:status;var modelCategoryId=parseInt($("#modelCategoryId").val());modelCategoryId=isNaN(modelCategoryId)?0:modelCategoryId;var modelId=parseInt($("#modelId").val());modelId=isNaN(modelId)?0:modelId;var procedureId=parseInt($("#procedureId").val());procedureId=isNaN(procedureId)?0:procedureId;var dateFrom=$("#dateFrom").val();dateFrom=dateFrom?dateFrom+" 00:00:00":"";var dateTo=$("#dateTo").val();dateTo=dateTo?dateTo+" 23:59:59":"";var params={page:page,limit:limit,workId:workId,status:status,modelCategoryId:modelCategoryId,modelId:modelId,procedureId:procedureId,dateFrom:dateFrom,dateTo:dateTo,compact:compact};var parts=[];$.each(params,function(name,value){parts.push(name+"="+encodeURIComponent(value))});return"?"+parts.join("&")},showWindow:function(html){$(".log-window .log-details").html(html);$(".log-window-wrapper").removeClass("hide-win")},hideWindow:function(){$(".log-window-wrapper").addClass("hide-win");setTimeout(function(){$(".log-window .log-details").html("");$(".log-window .log-title span").html("")},500)}});Chimera.DashboardPhoneConnections=new JS.Class(Chimera.DashboardWidget,{cssPrefix:".widget-phoneConnections ",initialize:function(attributes){this.callSuper(attributes);this.initWidget()},initWidget:function(){this.initPagination();this.initOverview()},initPagination:function(){var self=this;$(this.cssPrefix+".pagination a").click(function(e){var hist=$(self.cssPrefix+"#connectionsHistory");hist.html('<div class="loader"></div>');$(window).scrollTo(hist,500,{offset:{left:0,top:-100},axis:"y"});$.get($(this).attr("href"),function(response){hist.replaceWith($(response).find("#connectionsHistory"));self.initPagination()});e.stopPropagation();return false})},initOverview:function(){var self=this;$(this.cssPrefix+".view-button").click(function(e){$(self.cssPrefix+".view-button.hidden").removeClass("hidden");$(self.cssPrefix+".button:not(.view-button)").addClass("hidden");$(this).parent().find(".button").toggleClass("hidden");$("#workId, #modelCategoryId, #modelId, #procedureId").val(0);$("#dateFrom").val($(this).data("date-from"));$("#dateTo").val($(this).data("date-to"));$(".widget-jobHistory .search-button").trigger("click");$(window).scrollTo($(".widget-jobHistory"),500,{offset:{left:0,top:-100},axis:"y"});e.stopPropagation();return false});$(this.cssPrefix+".year-picker a").click(function(e){var overview=$(self.cssPrefix+"#connectionsOverview");overview.html('<div class="loader"></div>');$(window).scrollTo(overview,500,{offset:{left:0,top:-100},axis:"y"});$.get($(this).attr("href"),function(response){overview.replaceWith($(response).find("#connectionsOverview"));self.initOverview()});e.stopPropagation();return false})}});Chimera.DashboardSsuJobs=new JS.Class(Chimera.DashboardWidget,{cssPrefix:".widget-ssuJobs ",urlPrefix:"#ssu-jobs",initialize:function(attributes){this.callSuper(attributes);this.initWidget()},initWidget:function(){var self=this;var searchButton=$(this.cssPrefix+".search-button");searchButton.click(function(e){self.reloadWidget(false);e.stopPropagation();return false});$(".more-less").click(function(e){var a=$(this);var parent=a.parent();parent.find("span, p").toggle();if(a.html()+""==="More")a.html("Less");else a.html("More");e.stopPropagation();return false})},reloadWidget:function(keepPage){var self=this;var widget=$(this.cssPrefix);var params=this.getFilterParams(keepPage);widget.html('<div class="loader"></div>');$.ajax({url:"/"+language+"/dashboard/ssu-jobs"+params,async:true,cache:false,complete:function(xhr){widget.parent().parent().replaceWith(xhr.responseText);self.initWidget()}})},getFilterParams:function(keepPage){var dateFrom=$("#from").val();dateFrom=dateFrom?dateFrom:"";var dateTo=$("#to").val();dateTo=dateTo?dateTo:"";var params={from:dateFrom,to:dateTo};var parts=[];$.each(params,function(name,value){parts.push(name+"="+encodeURIComponent(value))});return"?"+parts.join("&")}});Chimera.DashboardConnectEasyFirmware=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes);var self=this;self.registerEvents()},registerEvents:function(){var self=this;var submit=$(".widget-connectEasyFirmware .button.submit");var form=$("#easyFirmwareForm");submit.click(function(){$(".widget-connectEasyFirmware .success-box, .widget-connectEasyFirmware .error-box").removeClass("animated fadeIn").hide();var data=form.serializeObject();self.app.post("/"+language+
"/dashboard/connect-easy-firmware",data,function(response){if(response.error)$(".widget-connectEasyFirmware .error-box").show().html(response.message).addClass("animated fadeIn");else self.reloadWidget()})})},reloadWidget:function(){var self=this;var widget=$(".widget-connectEasyFirmware");widget.html('<div class="loader"></div>');$.ajax({url:"/"+language+"/dashboard/connect-easy-firmware-widget",async:true,cache:false,complete:function(xhr){widget.replaceWith(xhr.responseText);chimeraApplication.layoutManager.updateAll();self.registerEvents()}})}});Chimera.DashboardSamsungEmHistory=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){if(typeof window.initializedDashboardSamsungEmHistory==="undefined")window.initializedDashboardSamsungEmHistory=true;else return;this.callSuper(attributes);if(this.app.currentParam&&this.app.currentParam.indexOf("id=")===0){var params=JSON.parse('{"'+decodeURI(this.app.currentParam).replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')+'"}');if(params&&params.id){var id=parseInt(params.id);if(id&&!isNaN(id)&&id>0)this.downloadById(id)}}},downloadById:function(id){$.getJSON("/"+language+"/dashboard/samsung-em-download",{id:id},function(response){window.result=response.result;window.filename=response.filename;if(response.success)window.open(response.url);else if(response.error)alert(response.error)})}});(function(a,b){if("function"==typeof define&&define.amd)define([],b);else if("undefined"!=typeof exports)b();else b(),a.FileSaver={exports:{}}.exports})(this,function(){function b(a,b){return"undefined"==typeof b?b={autoBom:!1}:"object"!=typeof b&&(console.warn("Deprecated: Expected third argument to be a object"),b={autoBom:!b}),b.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(a.type)?new Blob(["\ufeff",a],{type:a.type}):a}function c(a,b,c){var d=new XMLHttpRequest;d.open("GET",a),d.responseType="blob",d.onload=function(){g(d.response,b,c)},d.onerror=function(){console.error("could not download file")},d.send()}function d(a){var b=new XMLHttpRequest;b.open("HEAD",a,!1);try{b.send()}catch(a$0){}return 200<=b.status&&299>=b.status}function e(a){try{a.dispatchEvent(new MouseEvent("click"))}catch(c$1){var b=document.createEvent("MouseEvents");b.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),a.dispatchEvent(b)}}var f="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof global&&global.global===global?global:void 0,a=/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),g=f.saveAs||("object"!=typeof window||window!==f?function(){}:"download"in HTMLAnchorElement.prototype&&!a?function(b,g,h){var i=f.URL||f.webkitURL,j=document.createElement("a");g=g||b.name||"download",j.download=g,j.rel="noopener noreferrer","string"==typeof b?(j.href=b,j.origin===location.origin?e(j):d(j.href)?c(b,g,h):e(j,j.target="_blank")):(j.href=i.createObjectURL(b),setTimeout(function(){i.revokeObjectURL(j.href)},4E4),setTimeout(function(){e(j)},0))}:"msSaveOrOpenBlob"in navigator?function(f,g,h){if(g=g||f.name||"download","string"!=typeof f)navigator.msSaveOrOpenBlob(b(f,h),g);else if(d(f))c(f,g,h);else{var i=document.createElement("a");i.href=f,i.target="_blank",setTimeout(function(){e(i)})}}:function(b,d,e,g){if(g=g||open("","_blank"),g&&(g.document.title=g.document.body.innerText="downloading..."),"string"==typeof b)return c(b,d,e);var h="application/octet-stream"===b.type,i=/constructor/i.test(f.HTMLElement)||f.safari,j=/CriOS\/[\d]+/.test(navigator.userAgent);if((j||h&&i||a)&&"undefined"!=typeof FileReader){var k=new FileReader;k.onloadend=function(){var a=k.result;a=j?a:a.replace(/^data:[^;]*;/,"data:attachment/file;"),g?g.location.href=a:location=a,g=null},k.readAsDataURL(b)}else{var l=f.URL||f.webkitURL,m=l.createObjectURL(b);g?g.location=m:location.href=m,g=null,setTimeout(function(){l.revokeObjectURL(m)},4E4)}});f.saveAs=g.saveAs=g,"undefined"!=typeof module&&(module.exports=g)});Chimera.DashboardSamsungEmForm=new JS.Class(Chimera.DashboardWidget,{initialize:function(attributes){this.callSuper(attributes);var widget=$(".widget-samsungEmForm");if(widget.size()){var formIsValid=false;var latestVersion="";var version="";var didField=widget.find("#did");var v1ModesRow=widget.find(".mode-v1");var v2ModesRow=widget.find(".mode-v2");var submitButton=widget.find('input[type="submit"]');var submitText=submitButton.val();var workingText=submitButton.data("working");var check=widget.find(".check-confirm");var checkYes=check.find(".button.yes");var checkNo=check.find(".button.no");var invalidFormatMessage=widget.find(".invalid-format-message");var getDidAndVersion=function(){var did=didField.val()+"";version=did.length?did.length>=12&&did.substr(0,2)==="20"?2:1:"";return{did:did,version:version}};var validateForm=function(){var dv=getDidAndVersion();var valid=false;invalidFormatMessage.show();if(dv.version===1)valid=/^([0-9a-fA-F]{12})$/.test(dv.did);if(dv.version===2)valid=/^([0-9a-fA-F]{12,16})$/.test(dv.did);if(valid)valid=dv.did.length%2===0;if(valid)invalidFormatMessage.hide();valid=valid&&(dv.version===1&&v1ModesRow.find("input:checked").size()>0||dv.version===2&&v2ModesRow.find("input:checked").size()>0);if(valid)submitButton.removeAttr("disabled").prop("disabled",false).removeClass("disabled");else submitButton.attr("disabled","disabled").prop("disabled",true).addClass("disabled");formIsValid=valid};var didFieldChanged=function(){var dv=getDidAndVersion();if(dv.version!==latestVersion){switch(dv.version){case "":v1ModesRow.hide().find("input").removeAttr("checked").prop("checked",false).trigger("change");v2ModesRow.hide().find("input").removeAttr("checked").prop("checked",false).trigger("change");break;case 1:v2ModesRow.hide().find("input").removeAttr("checked").prop("checked",false).trigger("change");v1ModesRow.show();break;case 2:v1ModesRow.hide().find("input").removeAttr("checked").prop("checked",false).trigger("change");v2ModesRow.show();break}latestVersion=dv.version}validateForm()};didField.change(didFieldChanged).keyup(didFieldChanged);v1ModesRow.find("input").change(validateForm);v2ModesRow.find("input").change(validateForm);widget.find("form").submit(function(e){if(formIsValid&&!submitButton.hasClass("disabled"))check.addClass("opened");e.stopPropagation();return false});checkNo.click(function(e){check.removeClass("opened");e.stopPropagation();return false});checkYes.click(function(e){check.removeClass("opened");var dv=getDidAndVersion();var data={did:dv.did,version:dv.version,mode:null};if(dv.version===1)data.mode=v1ModesRow.find("input:checked").val();else{data.mode=[];$.each(v2ModesRow.find("input:checked"),function(i,input){data.mode.push($(input).val())})}submitButton.attr("disabled","disabled").prop("disabled",true).addClass("disabled").val(workingText);$.getJSON("/"+language+"/dashboard/samsung-em-save",{em:data},function(response){if(response.success&&response.id)window.location.href="#samsung-em-history?id="+response.id;else{if(response.error)alert(response.error);submitButton.removeAttr("disabled").prop("disabled",false).removeClass("disabled").val(submitText);validateForm()}});e.stopPropagation();return false})}}});var dashboardApplication=new Chimera.Dashboard;